# SNS Fan-Out Pattern Example
# One topic distributes messages to multiple subscribers with filtering

namespace: sns-fanout

# Main events topic
events-topic:
  defines: aws-sns/sns-topic
  region: us-east-1
  topic_name: events-topic
  display_name: Application Events
  services:
    topic:
      protocol: custom
  tags:
    Application: event-system
    Environment: demo
    ManagedBy: monk

# SQS Queue for order events
orders-queue:
  defines: aws-sqs/sqs-queue
  region: us-east-1
  queue_name: orders-queue
  message_retention_period: 345600  # 4 days
  visibility_timeout: 30
  sqs_managed_sse_enabled: true
  services:
    queue:
      protocol: custom
  tags:
    Purpose: orders
    Environment: demo

# SQS Queue for payment events
payments-queue:
  defines: aws-sqs/sqs-queue
  region: us-east-1
  queue_name: payments-queue
  message_retention_period: 345600  # 4 days
  visibility_timeout: 30
  sqs_managed_sse_enabled: true
  services:
    queue:
      protocol: custom
  tags:
    Purpose: payments
    Environment: demo

# SQS Queue for high-priority events (no filter)
priority-queue:
  defines: aws-sqs/sqs-queue
  region: us-east-1
  queue_name: priority-queue
  message_retention_period: 345600  # 4 days
  visibility_timeout: 30
  sqs_managed_sse_enabled: true
  services:
    queue:
      protocol: custom
  tags:
    Purpose: priority
    Environment: demo

# Orders subscription - only receives order events
orders-subscription:
  defines: aws-sns/sns-subscription
  region: us-east-1
  topic_arn: <- connection-target("topic") entity-state get-member("topic_arn")
  protocol: sqs
  endpoint: <- connection-target("queue") entity-state get-member("queue_arn")
  raw_message_delivery: true
  filter_policy: |
    {
      "event_type": ["order_created", "order_shipped", "order_cancelled"]
    }
  connections:
    topic:
      runnable: sns-fanout/events-topic
      service: topic
    queue:
      runnable: sns-fanout/orders-queue
      service: queue
  depends:
    wait-for:
      runnables:
        - sns-fanout/events-topic
        - sns-fanout/orders-queue
      timeout: 60

# Payments subscription - only receives payment events
payments-subscription:
  defines: aws-sns/sns-subscription
  region: us-east-1
  topic_arn: <- connection-target("topic") entity-state get-member("topic_arn")
  protocol: sqs
  endpoint: <- connection-target("queue") entity-state get-member("queue_arn")
  raw_message_delivery: true
  filter_policy: |
    {
      "event_type": ["payment_received", "payment_failed", "refund_processed"]
    }
  connections:
    topic:
      runnable: sns-fanout/events-topic
      service: topic
    queue:
      runnable: sns-fanout/payments-queue
      service: queue
  depends:
    wait-for:
      runnables:
        - sns-fanout/events-topic
        - sns-fanout/payments-queue
      timeout: 60

# Priority subscription - receives ALL events (no filter)
priority-subscription:
  defines: aws-sns/sns-subscription
  region: us-east-1
  topic_arn: <- connection-target("topic") entity-state get-member("topic_arn")
  protocol: sqs
  endpoint: <- connection-target("queue") entity-state get-member("queue_arn")
  raw_message_delivery: true
  connections:
    topic:
      runnable: sns-fanout/events-topic
      service: topic
    queue:
      runnable: sns-fanout/priority-queue
      service: queue
  depends:
    wait-for:
      runnables:
        - sns-fanout/events-topic
        - sns-fanout/priority-queue
      timeout: 60

# Email subscription for critical events
# NOTE: Change admin@example.com to your actual email address!
email-subscription:
  defines: aws-sns/sns-subscription
  region: us-east-1
  topic_arn: <- connection-target("topic") entity-state get-member("topic_arn")
  protocol: email
  endpoint: admin@example.com  # TODO: Change this to your email!
  filter_policy: |
    {
      "priority": ["critical"],
      "event_type": ["payment_failed", "order_cancelled"]
    }
  connections:
    topic:
      runnable: sns-fanout/events-topic
      service: topic
  depends:
    wait-for:
      runnables:
        - sns-fanout/events-topic
      timeout: 60

# Test publisher application
event-publisher:
  defines: runnable
  connections:
    topic:
      runnable: sns-fanout/events-topic
      service: topic
  depends:
    wait-for:
      runnables:
        - sns-fanout/events-topic
        - sns-fanout/orders-subscription
        - sns-fanout/payments-subscription
        - sns-fanout/priority-subscription
      timeout: 180
  variables:
    topic_arn:
      env: TOPIC_ARN
      value: <- connection-target("topic") entity-state get-member("topic_arn")
      type: string
    
    aws_region:
      env: AWS_REGION
      value: "us-east-1"
      type: string

  containers:
    publisher:
      image: alpine:latest
      bash: |
        set -e
        
        echo "ðŸ“¤ Event Publisher Starting..."
        echo "Installing dependencies..."
        
        apk add --no-cache python3 py3-pip > /dev/null 2>&1
        pip3 install --no-cache-dir boto3 --break-system-packages > /dev/null 2>&1
        
        echo ""
        echo "Publishing test events to SNS topic..."
        echo "Topic ARN: $TOPIC_ARN"
        echo ""
        
        python3 << 'PYEOF'
        import boto3
        import json
        import time
        from datetime import datetime
        import os
        
        sns = boto3.client('sns', region_name=os.environ['AWS_REGION'])
        topic_arn = os.environ['TOPIC_ARN']
        
        def publish_event(event_type, priority="normal", data=None):
            message = {
                "timestamp": datetime.now().isoformat(),
                "event_type": event_type,
                "priority": priority,
                "data": data or {}
            }
            
            # Message attributes for filtering
            attributes = {
                'event_type': {
                    'DataType': 'String',
                    'StringValue': event_type
                },
                'priority': {
                    'DataType': 'String',
                    'StringValue': priority
                }
            }
            
            response = sns.publish(
                TopicArn=topic_arn,
                Message=json.dumps(message),
                Subject=f'Event: {event_type}',
                MessageAttributes=attributes
            )
            
            print(f"âœ… Published: {event_type} (priority: {priority}) - MessageId: {response['MessageId']}")
            return response
        
        print("Publishing test events...")
        print("")
        
        # Order events (will go to orders-queue and priority-queue)
        print("1ï¸âƒ£  Order Events:")
        publish_event('order_created', 'normal', {'order_id': 'ORD-001', 'amount': 99.99})
        time.sleep(0.5)
        publish_event('order_shipped', 'normal', {'order_id': 'ORD-001', 'tracking': 'TRK-123'})
        time.sleep(0.5)
        
        # Payment events (will go to payments-queue and priority-queue)
        print("")
        print("2ï¸âƒ£  Payment Events:")
        publish_event('payment_received', 'normal', {'payment_id': 'PAY-001', 'amount': 99.99})
        time.sleep(0.5)
        
        # Critical payment failure (will go to payments-queue, priority-queue, AND email)
        print("")
        print("3ï¸âƒ£  Critical Event:")
        publish_event('payment_failed', 'critical', {'payment_id': 'PAY-002', 'error': 'insufficient_funds'})
        time.sleep(0.5)
        
        # Cancelled order (will go to orders-queue, priority-queue, AND email)
        publish_event('order_cancelled', 'critical', {'order_id': 'ORD-002', 'reason': 'customer_request'})
        time.sleep(0.5)
        
        # Refund (will go to payments-queue and priority-queue)
        print("")
        print("4ï¸âƒ£  Refund Event:")
        publish_event('refund_processed', 'normal', {'refund_id': 'REF-001', 'amount': 99.99})
        
        print("")
        print("âœ… All events published successfully!")
        print("")
        print("ðŸ“Š Expected message distribution:")
        print("   - Orders Queue:    3 messages (order_created, order_shipped, order_cancelled)")
        print("   - Payments Queue:  3 messages (payment_received, payment_failed, refund_processed)")
        print("   - Priority Queue:  5 messages (ALL events)")
        print("   - Email:           2 messages (payment_failed, order_cancelled with priority=critical)")
        PYEOF

# Complete stack
fanout-stack:
  defines: process-group
  runnable-list:
    - sns-fanout/events-topic
    - sns-fanout/orders-queue
    - sns-fanout/payments-queue
    - sns-fanout/priority-queue
    - sns-fanout/orders-subscription
    - sns-fanout/payments-subscription
    - sns-fanout/priority-subscription
    - sns-fanout/email-subscription
    - sns-fanout/event-publisher

