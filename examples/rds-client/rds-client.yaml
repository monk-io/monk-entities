namespace: rds-client-demo

# RDS Client Application Demo
# This demonstrates how to use an RDS instance created by the aws-rds entity

rds-demo-app:
  defines: process-group
  runnable-list:
    - mysql-database
    - mysql-client
    - postgres-database  
    - postgres-client

# MySQL RDS Instance
mysql-database:
  defines: aws-rds/rds-instance
  permitted-secrets:
    demo-mysql-db-master-password: true
  variables:
    db-instance-identifier: demo-mysql-db
    region: us-east-1
  
  # AWS Configuration
  region: us-east-1
    
  # Database configuration
  db_instance_identifier: <- `${db-instance-identifier}`
  db_name: mydatabase
  allocated_storage: 20
  max_allocated_storage: 100
  db_instance_class: db.t3.micro
  engine: mysql
  engine_version: "8.0"
  master_username: admin
  password_secret_ref: <- `${db-instance-identifier}-master-password`
  
  # Network and security
  publicly_accessible: false  # Enable public access for demo

  # Auto-create security group in default VPC (no vpc_id specified)
  auto_create_security_group: true
  security_group_name: mysql-database-sg
  security_group_description: "MySQL Database Security Group"
  # # Allow access from specific security groups by name
  # allowed_security_group_names:
  #   - "test-rds" # AWS node security group (node name)
  #   - "test-rds2" 
  # # allowed_cidr_blocks:
  # #   - "0.0.0.0/0"
  
  # Backup and maintenance
  backup_retention_period: 7
  backup_window: "03:00-04:00"
  maintenance_window: "sun:04:00-sun:05:00"
  auto_minor_version_upgrade: true
  
  # Performance and monitoring
  monitoring_interval: 0  # Disable enhanced monitoring (requires IAM role)
  performance_insights_enabled: false  # Not supported on db.t3.micro
  enabled_cloudwatch_logs_exports:
    - error
    - general
    - slow-query
  
  # Deletion protection
  skip_final_snapshot: true
  deletion_protection: false
  
  tags:
    Environment: demo
    Application: rds-client
    Engine: mysql

# MySQL Client Application
mysql-client:
  defines: runnable
  permitted-secrets:
    demo-mysql-db-master-password: true
  connections:
    db:
      runnable: rds-client-demo/mysql-database
      service: default
  depends:
    wait-for:
      runnables:
        - rds-client-demo/mysql-database
      timeout: 600
  variables:
    mysql_endpoint:
      env: DB_HOST
      value: <- connection-target("db") entity-state get-member("endpoint_address")
      type: string
    mysql_port:
      env: DB_PORT
      value: <- connection-target("db") entity-state get-member("endpoint_port")
      type: string
    mysql_database:
      env: DB_NAME
      value: <- connection-target("db") entity get-member("db_name")
      type: string
    mysql_user:
      env: DB_USER
      value: <- connection-target("db") entity get-member("master_username")
      type: string
    mysql_password_secret:
      value: <- connection-target("db") entity get-member("password_secret_ref")
      type: string
    mysql_password:
      env: DB_PASSWORD
      value: <- secret($mysql_password_secret)
      type: string
  
  containers:
    client:
      image: docker.io/imanachyn/rds-client:v1
      environment:
        - DB_ENGINE=mysql
        - DB_CONNECTION_LIMIT=5
        - DB_TIMEOUT=10000
        - OPERATION_INTERVAL_MS=10000
        - SAMPLE_TABLE_NAME=demo_users
        - SAMPLE_RECORDS_COUNT=5

mysql-access-list:
  defines: aws-rds/rds-access-list
  region: <- connection-target("db") entity get-member("region")
  security_group_id: <- connection-target("db") entity-state get-member("created_security_group_id")
  port: <- connection-target("db") entity-state get-member("endpoint_port")
  allowed_security_group_names: <- runnable-peers("rds-client-demo/mysql-client")
  connections:
    db:
      runnable: rds-client-demo/mysql-database
      service: default
  depends:
    wait-for:
      runnables:
        - rds-client-demo/mysql-database
        - rds-client-demo/mysql-client
      timeout: 600

# PostgreSQL RDS Instance  
postgres-database:
  defines: aws-rds/rds-instance
  permitted-secrets:
    demo-postgres-db-master-password: true
  variables:
    db-instance-identifier: demo-postgres-db
    region: us-east-1
  
  # AWS Configuration
  region: us-east-1
    
  # Database configuration
  db_instance_identifier: <- `${db-instance-identifier}`
  db_name: mydatabase
  allocated_storage: 20
  max_allocated_storage: 100
  db_instance_class: db.t3.micro
  engine: postgres
  engine_version: "15"
  master_username: postgres
  password_secret_ref: <- `${db-instance-identifier}-master-password`
  
  # Network and security
  publicly_accessible: true
  auto_create_security_group: true
  security_group_name: postgres-database-sg
  security_group_description: "PostgreSQL Database Security Group"
  
  # Backup and maintenance
  backup_retention_period: 7
  backup_window: "03:00-04:00"
  maintenance_window: "sun:04:00-sun:05:00"
  auto_minor_version_upgrade: true
  
  # Performance and monitoring
  monitoring_interval: 0  # Disable enhanced monitoring (requires IAM role)
  performance_insights_enabled: false  # Not supported on db.t3.micro
  enabled_cloudwatch_logs_exports:
    - postgresql
  
  # Deletion protection
  skip_final_snapshot: true
  deletion_protection: false
  
  tags:
    Environment: demo
    Application: rds-client
    Engine: postgresql

# PostgreSQL Client Application
postgres-client:
  defines: runnable
  permitted-secrets:
    demo-postgres-db-master-password: true
  connections:
    db:
      runnable: rds-client-demo/postgres-database
      service: default
  depends:
    wait-for:
      runnables:
        - rds-client-demo/postgres-database
      timeout: 600
  variables:
    postgres_endpoint:
      env: DB_HOST
      value: <- connection-target("db") entity-state get-member("endpoint_address")
      type: string
    postgres_port:
      env: DB_PORT
      value: <- connection-target("db") entity-state get-member("endpoint_port")
      type: string
    postgres_database:
      env: DB_NAME
      value: <- connection-target("db") entity get-member("db_name")
      type: string
    postgres_user:
      env: DB_USER
      value: <- connection-target("db") entity get-member("master_username")
      type: string
    postgres_password_secret:
      value: <- connection-target("db") entity get-member("password_secret_ref")
      type: string
    postgres_password:
      env: DB_PASSWORD
      value: <- secret($postgres_password_secret)
      type: string
  
  containers:
    client:
      image: docker.io/imanachyn/rds-client:v1
      environment:
        - DB_ENGINE=postgresql
        - DB_CONNECTION_LIMIT=5
        - DB_TIMEOUT=10000
        - OPERATION_INTERVAL_MS=10000
        - SAMPLE_TABLE_NAME=demo_users
        - SAMPLE_RECORDS_COUNT=5 

postgres-access-list:
  defines: aws-rds/rds-access-list
  region: <- connection-target("db") entity get-member("region")
  security_group_id: <- connection-target("db") entity-state get-member("created_security_group_id")
  port: <- connection-target("db") entity-state get-member("endpoint_port")
  allowed_cidr_blocks: <- runnable-peers-public-ips("rds-client-demo/postgres-client")
  connections:
    db:
      runnable: rds-client-demo/postgres-database
      service: default
  depends:
    wait-for:
      runnables:
        - rds-client-demo/postgres-database
        - rds-client-demo/postgres-client
      timeout: 600