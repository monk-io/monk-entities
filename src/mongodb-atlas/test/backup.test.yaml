name: "MongoDB Atlas Backup Actions Test"
description: "Test backup and snapshot listing actions for MongoDB Atlas clusters"
timeout: 900000

# NOTE: This test requires a dedicated cluster (M10 or higher) to run backup operations.
# Shared tier clusters (M0, M2, M5) do not support the backup API and will fail with
# an appropriate error message.

secrets:
  global:
    mongodb-atlas-token: "$MONGODB_ATLAS_TOKEN"

setup:
  - name: "Load compiled MongoDB Atlas entities"
    action: "load"
    target: "dist/input/mongodb-atlas/MANIFEST"
    expect:
      exitCode: 0

  - name: "Load backup test template"
    action: "load"
    target: "backup-template.yaml"
    expect:
      exitCode: 0

tests:
  - name: "Deploy backup test stack"
    action: "run"
    target: "mongodb-backup-test/backup-stack"
    expect:
      exitCode: 0

  - name: "Wait for cluster readiness"
    action: "wait"
    target: "mongodb-backup-test/backup-cluster"
    waitFor:
      condition: "ready"
      timeout: 600000

  - name: "Verify cluster is running"
    action: "describe"
    target: "mongodb-backup-test/backup-cluster"
    expect:
      exitCode: 0

  # Test backup creation
  - name: "Create backup snapshot"
    action: "exec"
    target: "mongodb-backup-test/backup-cluster"
    command: "monk do mongodb-backup-test/backup-cluster backup description='CI test backup' retentionInDays=3"
    expect:
      exitCode: 0
      contains:
        - "Snapshot creation initiated successfully"
        - "Snapshot ID:"

  # Wait for snapshot to be created
  - name: "Wait for snapshot creation"
    action: "wait"
    timeout: 120000

  # Test listing snapshots
  - name: "List available snapshots"
    action: "exec"
    target: "mongodb-backup-test/backup-cluster"
    command: "monk do mongodb-backup-test/backup-cluster list-snapshots"
    expect:
      exitCode: 0
      contains:
        - "Listing backup snapshots"
        - "Total snapshots available:"

  # Test listing with limit parameter
  - name: "List snapshots with limit"
    action: "exec"
    target: "mongodb-backup-test/backup-cluster"
    command: "monk do mongodb-backup-test/backup-cluster list-snapshots limit=5"
    expect:
      exitCode: 0
      contains:
        - "Showing:"
        - "snapshot(s)"

  # Test backup validation for shared tier (should fail gracefully)
  # This test is commented out as it requires a separate M0 cluster
  # Uncomment if testing validation logic
  # - name: "Verify backup validation for shared tier"
  #   action: "exec"
  #   target: "mongodb-backup-test/shared-cluster"
  #   command: "monk do mongodb-backup-test/shared-cluster backup"
  #   expect:
  #     exitCode: 1
  #     contains:
  #       - "Backup operations are not supported for shared cluster tier"

cleanup:
  - name: "Delete backup test stack"
    action: "delete"
    target: "mongodb-backup-test/backup-stack"
    expect:
      exitCode: 0

  - name: "Cleanup snapshots (manual)"
    action: "log"
    message: "Note: Snapshots should be manually cleaned up via Atlas console if needed"

