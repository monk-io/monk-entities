name: "MongoDB Atlas Backup Integration Test"
description: "Integration test for MongoDB Atlas backup operations using standardized action names"
timeout: 1200000

# NOTE: This test requires a dedicated cluster (M10 or higher) to run backup operations.
# Shared tier clusters (M0, M2, M5) do not support the backup API.

secrets:
  global:
    mongodb-atlas-token: "$MONGODB_ATLAS_TOKEN"

setup:
  - name: "Load MongoDB Atlas entity manifest"
    action: "load"
    target: "dist/input/mongodb-atlas/MANIFEST"
    expect:
      exitCode: 0

  - name: "Load backup test template"
    action: "load"
    target: "backup-template.yaml"
    expect:
      exitCode: 0

tests:
  # ==================== CLUSTER SETUP ====================
  - name: "Deploy backup test stack"
    action: "run"
    target: "mongodb-backup-test/backup-stack"
    expect:
      exitCode: 0

  - name: "Wait for cluster readiness"
    action: "wait"
    target: "mongodb-backup-test/backup-cluster"
    waitFor:
      condition: "ready"
      timeout: 900000

  - name: "Verify cluster is running"
    action: "describe"
    target: "mongodb-backup-test/backup-cluster"
    expect:
      exitCode: 0

  # ==================== BACKUP INFO ====================
  - name: "Get backup policy info"
    action: "do"
    target: "mongodb-backup-test/backup-cluster/get-backup-info"
    expect:
      exitCode: 0
      contains:
        - "Backup"

  # ==================== SNAPSHOT OPERATIONS ====================
  - name: "Create backup snapshot"
    action: "do"
    target: "mongodb-backup-test/backup-cluster/create-snapshot"
    args:
      description: "CI test backup snapshot"
      retention_days: "3"
    expect:
      exitCode: 0
      contains:
        - "Snapshot"

  - name: "List available snapshots"
    action: "do"
    target: "mongodb-backup-test/backup-cluster/list-snapshots"
    expect:
      exitCode: 0

  - name: "List snapshots with limit"
    action: "do"
    target: "mongodb-backup-test/backup-cluster/list-snapshots"
    args:
      limit: "5"
    expect:
      exitCode: 0

  # Wait for snapshot availability
  - name: "Wait for snapshot availability"
    action: "wait-command"
    target: "monk do mongodb-backup-test/backup-cluster/list-snapshots"
    waitFor:
      timeout: 300000
      pollInterval: 30000
    expect:
      exitCode: 0
      contains:
        - "completed"
    skip_if_missing: true

  # ==================== VALIDATION TESTS ====================
  - name: "Validate describe-snapshot requires snapshot_id"
    action: "do"
    target: "mongodb-backup-test/backup-cluster/describe-snapshot"
    expect:
      exitCode: 1
      contains:
        - "snapshot_id"

  - name: "Validate restore requires snapshot_id"
    action: "do"
    target: "mongodb-backup-test/backup-cluster/restore"
    expect:
      exitCode: 1
      contains:
        - "snapshot_id"

  - name: "Validate get-restore-status requires job_id"
    action: "do"
    target: "mongodb-backup-test/backup-cluster/get-restore-status"
    expect:
      exitCode: 1
      contains:
        - "job_id"

  # ==================== RESTORE JOBS ====================
  - name: "List restore jobs"
    action: "do"
    target: "mongodb-backup-test/backup-cluster/list-restore-jobs"
    expect:
      exitCode: 0

cleanup:
  - name: "Delete backup test stack"
    action: "delete"
    target: "mongodb-backup-test/backup-stack"
    expect:
      exitCode: 0

  # Note: Snapshots and restored clusters should be manually cleaned up via Atlas console if needed
