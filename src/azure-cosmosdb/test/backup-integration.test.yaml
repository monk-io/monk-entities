name: "Azure Cosmos DB Backup Integration Test"
description: "Integration test for Azure Cosmos DB continuous backup and point-in-time restore operations"
timeout: 1200000

setup:
  - name: "Load Azure Cosmos DB entity manifest"
    action: "load"
    target: "dist/input/azure-cosmosdb/MANIFEST"
    expect:
      exitCode: 0

  - name: "Load backup test template"
    action: "load"
    target: "test/backup-template.yaml"
    expect:
      exitCode: 0

tests:
  # ==================== ACCOUNT SETUP ====================
  - name: "Deploy backup test account"
    action: "run"
    target: "azure-cosmosdb-backup-test/backup-account"
    expect:
      exitCode: 0

  - name: "Wait for account readiness"
    action: "wait"
    target: "azure-cosmosdb-backup-test/backup-account"
    waitFor:
      condition: "ready"
      timeout: 900000

  - name: "Verify account is running"
    action: "describe"
    target: "azure-cosmosdb-backup-test/backup-account"
    expect:
      exitCode: 0

  # ==================== BACKUP INFO ====================
  - name: "Get backup configuration info"
    action: "do"
    target: "azure-cosmosdb-backup-test/backup-account/get-backup-info"
    expect:
      exitCode: 0
      contains:
        - "Backup"
        - "Continuous"

  # ==================== DATABASE AND CONTAINER SETUP ====================
  - name: "Deploy backup test database"
    action: "run"
    target: "azure-cosmosdb-backup-test/backup-database"
    expect:
      exitCode: 0

  - name: "Wait for database readiness"
    action: "wait"
    target: "azure-cosmosdb-backup-test/backup-database"
    waitFor:
      condition: "ready"
      timeout: 300000

  - name: "Deploy backup test container"
    action: "run"
    target: "azure-cosmosdb-backup-test/backup-container"
    expect:
      exitCode: 0

  - name: "Wait for container readiness"
    action: "wait"
    target: "azure-cosmosdb-backup-test/backup-container"
    waitFor:
      condition: "ready"
      timeout: 300000

  # ==================== RESTORABLE RESOURCES ====================
  - name: "List restorable accounts"
    action: "do"
    target: "azure-cosmosdb-backup-test/backup-account/list-restorable-accounts"
    expect:
      exitCode: 0

  # ==================== VALIDATION TESTS ====================
  - name: "Validate list-restorable-databases requires source_id"
    action: "do"
    target: "azure-cosmosdb-backup-test/backup-account/list-restorable-databases"
    expect:
      exitCode: 1
      contains:
        - "source_id"

  - name: "Validate list-restorable-containers requires source_id"
    action: "do"
    target: "azure-cosmosdb-backup-test/backup-account/list-restorable-containers"
    expect:
      exitCode: 1
      contains:
        - "source_id"

  - name: "Validate restore requires source_id"
    action: "do"
    target: "azure-cosmosdb-backup-test/backup-account/restore"
    expect:
      exitCode: 1
      contains:
        - "source_id"

cleanup:
  - name: "Delete backup test container"
    action: "delete"
    target: "azure-cosmosdb-backup-test/backup-container"
    expect:
      exitCode: 0

  - name: "Delete backup test database"
    action: "delete"
    target: "azure-cosmosdb-backup-test/backup-database"
    expect:
      exitCode: 0

  - name: "Delete backup test account"
    action: "delete"
    target: "azure-cosmosdb-backup-test/backup-account"
    expect:
      exitCode: 0

  # Note: If restore was executed, the restored account should be manually deleted via Azure Portal
