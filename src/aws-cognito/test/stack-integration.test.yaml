name: "AWS Cognito User Pool Integration Test"
description: "Complete integration test for AWS Cognito User Pool entity using Monk runtime"
timeout: 300000

setup:
  - name: "Load compiled Cognito entities"
    action: "load"
    target: "dist/input/aws-cognito/MANIFEST"
    expect:
      exitCode: 0

  - name: "Load User Pool test template"
    action: "load" 
    target: "stack-template.yaml"
    expect:
      exitCode: 0

tests:
  # Basic User Pool Tests
  - name: "Create and start basic User Pool"
    action: "run"
    target: "cognito-test/test-user-pool"
    expect:
      exitCode: 0
      output:
        - "Started"

  - name: "Wait for basic User Pool readiness"
    action: "wait"
    target: "cognito-test/test-user-pool"
    waitFor:
      condition: "ready"
      timeout: 60000

  - name: "Get basic User Pool information"
    action: "do"
    target: "cognito-test/test-user-pool/get-pool-info"
    expect:
      exitCode: 0
      output:
        - "User Pool Information"
        - "Pool ID:"
        - "Pool Name: monk-test-user-pool"
        - "Status:"

  - name: "List users in basic User Pool (should be empty)"
    action: "do"
    target: "cognito-test/test-user-pool/list-users"
    expect:
      exitCode: 0
      output:
        - "User Pool Users"
        - "No users found"

  - name: "Get User Pool clients (should be empty)"
    action: "do"
    target: "cognito-test/test-user-pool/get-user-pool-clients"
    expect:
      exitCode: 0
      output:
        - "User Pool Clients"
        - "No clients found"

  - name: "Create a test user in basic User Pool"
    action: "do"
    target: "cognito-test/test-user-pool/create-user"
    args:
      username: "testuser@example.com"
      temporary_password: "TempPass123!"
      message_action: "SUPPRESS"
      user_attributes: '{"email": "testuser@example.com", "given_name": "Test", "family_name": "User"}'
    expect:
      exitCode: 0
      output:
        - "User Created Successfully"
        - "Username: testuser@example.com"

  - name: "List users after creation (should show 1 user)"
    action: "do"
    target: "cognito-test/test-user-pool/list-users"
    expect:
      exitCode: 0
      output:
        - "Found 1 users"
        - "testuser@example.com"

  # Advanced User Pool Tests
  - name: "Create and start advanced User Pool"
    action: "run"
    target: "cognito-test/test-advanced-user-pool"
    expect:
      exitCode: 0
      output:
        - "Started"

  - name: "Wait for advanced User Pool readiness"
    action: "wait"
    target: "cognito-test/test-advanced-user-pool"
    waitFor:
      condition: "ready"
      timeout: 60000

  - name: "Get advanced User Pool information"
    action: "do"
    target: "cognito-test/test-advanced-user-pool/get-pool-info"
    expect:
      exitCode: 0
      output:
        - "User Pool Information"
        - "Pool Name: monk-test-advanced-user-pool"
        - "MFA Configuration: ON"
        - "Password Policy"
        - "Minimum Length: 10"

  - name: "Create admin user in advanced User Pool"
    action: "do"
    target: "cognito-test/test-advanced-user-pool/create-user"
    args:
      username: "admin@example.com"
      temporary_password: "AdminPass123!"
      message_action: "SUPPRESS"
      user_attributes: '{"email": "admin@example.com", "given_name": "Admin", "family_name": "User", "custom:department": "IT", "custom:employee_id": "12345"}'
    expect:
      exitCode: 0
      output:
        - "User Created Successfully"
        - "Username: admin@example.com"

  # Update Tests
  - name: "Update basic User Pool configuration"
    action: "update"
    target: "cognito-test/test-user-pool"
    expect:
      exitCode: 0

  - name: "Verify basic User Pool still works after update"
    action: "do"
    target: "cognito-test/test-user-pool/get-pool-info"
    expect:
      exitCode: 0
      output:
        - "User Pool Information"
        - "Pool Name: monk-test-user-pool"

cleanup:
  - name: "Stop and delete basic User Pool"
    action: "delete"
    target: "cognito-test/test-user-pool"
    expect:
      exitCode: 0

  - name: "Stop and delete advanced User Pool"
    action: "delete"
    target: "cognito-test/test-advanced-user-pool"
    expect:
      exitCode: 0
