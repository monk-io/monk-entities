namespace: stripe-example

creds:
  defines: stripe/credentials
  permitted-secrets:
    stripe-secret-key: true
  secret_ref: stripe-secret-key
  publishable_key: "pk_test_example"
  services:
    data:
      protocol: custom

webhook:
  defines: stripe/webhook-endpoint
  secret_ref: stripe-secret-key
  destination_url: https://example.org/stripe/webhook
  event_types:
    - checkout.session.completed
    - customer.subscription.updated
  signing_secret_ref: stripe-webhook-secret
  permitted-secrets:
    stripe-secret-key: true
    stripe-webhook-secret: true
  services:
    data:
      protocol: custom

consumer:
  defines: runnable
  permitted-secrets:
    stripe-secret-key: true
    stripe-webhook-secret: true
  connections:
    creds:
      runnable: stripe-example/creds
      service: data
    webhook:
      runnable: stripe-example/webhook
      service: data
    product:
      runnable: stripe-example/product
      service: data
    price:
      runnable: stripe-example/price
      service: data
  depends:
    wait-for:
      runnables:
        - stripe-example/creds
        - stripe-example/webhook
        - stripe-example/product
        - stripe-example/price
      timeout: 60
  variables:
    stripe_secret_ref:
      value: <- connection-target("creds") entity get-member("secret_ref")
      type: string
    stripe_webhook_secret_ref:
      value: <- connection-target("webhook") entity-state get-member("webhook_signing_secret_secret")
      type: string
    STRIPE_SECRET_KEY:
      env: STRIPE_SECRET_KEY
      type: string
      value: <- secret($stripe_secret_ref)
    STRIPE_PUBLISHABLE_KEY:
      env: STRIPE_PUBLISHABLE_KEY
      type: string
      value: <- connection-target("creds") entity-state get-member("publishable_key")
    STRIPE_ACCOUNT_ID:
      env: STRIPE_ACCOUNT_ID
      type: string
      value: <- connection-target("creds") entity-state get-member("account_id")
    STRIPE_MODE:
      env: STRIPE_MODE
      type: string
      value: <- connection-target("creds") entity-state get-member("mode")
    STRIPE_WEBHOOK_SECRET:
      env: STRIPE_WEBHOOK_SECRET
      type: string
      value: <- secret($stripe_webhook_secret_ref)
    STRIPE_PRODUCT_ID:
      env: STRIPE_PRODUCT_ID
      type: string
      value: <- connection-target("product") entity-state get-member("product_id")
    STRIPE_PRICE_ID:
      env: STRIPE_PRICE_ID
      type: string
      value: <- connection-target("price") entity-state get-member("price_id")
    # Optional env if price connected
    # STRIPE_PRICE_ID:
    #   env: STRIPE_PRICE_ID
    #   type: string
    #   value: <- connection-target("price") entity-state get-member("price_id")
  containers:
    app:
      image: curlimages/curl:8.10.1
      entrypoint: sleep 36000

# Optional product and price resolution
product:
  defines: stripe/product
  secret_ref: stripe-secret-key
  name: example-product
  product_description: Example product managed by Monk
  permitted-secrets:
    stripe-secret-key: true
  services:
    data:
      protocol: custom

price:
  defines: stripe/price
  secret_ref: stripe-secret-key
  connections:
    product:
      runnable: stripe-example/product
      service: data
  depends:
    wait-for:
      runnables:
        - stripe-example/product
      timeout: 120
  product_id: <- connection-target("product") entity-state get-member("product_id")
  lookup_key: example_price_basic
  currency: usd
  unit_amount: 500
  recurring_interval: month
  permitted-secrets:
    stripe-secret-key: true
  services:
    data:
      protocol: custom



