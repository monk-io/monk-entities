# GCP Entities Example Stack
#
# This example demonstrates how to use GCP entities together
# to provision a complete infrastructure stack.

namespace: gcp-example

# =============================================================================
# Step 1: Enable Required APIs
# =============================================================================
# This should run first to ensure all required GCP APIs are enabled.

enable-apis:
  defines: gcp/service-usage
  apis:
    - sqladmin.googleapis.com
    - bigquery.googleapis.com
    - storage.googleapis.com
    - iam.googleapis.com

# =============================================================================
# Step 2: Create Service Account (optional)
# =============================================================================
# Create a service account for your application with necessary permissions.

app-service-account:
  defines: gcp/service-account
  name: my-app-sa
  display_name: My Application Service Account
  description: Service account for my application
  roles:
    - roles/cloudsql.client
    - roles/storage.objectViewer
    - roles/bigquery.dataViewer
  depends:
    wait-for:
      runnables:
        - gcp-example/enable-apis
      timeout: 300

app-service-account-key:
  defines: gcp/service-account-key
  secret: app-sa-credentials
  service_account_id: <- connection-target("service-account") entity-state get-member("unique_id")
  permitted-secrets:
    app-sa-credentials: true
  connections:
    service-account:
      runnable: gcp-example/app-service-account
      service: service-account
  depends:
    wait-for:
      runnables:
        - gcp-example/app-service-account
      timeout: 60

# =============================================================================
# Step 3: Create Cloud SQL Instance
# =============================================================================
# PostgreSQL instance for application data.

postgres-instance:
  defines: gcp/cloud-sql-instance
  name: my-app-postgres
  database_version: POSTGRES_14
  tier: db-f1-micro
  region: us-central1
  allow_all: true  # For development only - restrict in production!
  storage_size_gb: 10
  services:
    instance:
      protocol: tcp
      address: <- entity-state get-member("address") default("")
      port: <- entity-state get-member("port") default(5432) to-int
  depends:
    wait-for:
      runnables:
        - gcp-example/enable-apis
      timeout: 300

# =============================================================================
# Step 4: Create Database and User
# =============================================================================
# These depend on the instance being ready.

app-database:
  defines: gcp/cloud-sql-database
  instance: <- connection-target("instance") entity get-member("name")
  name: myapp_production
  services:
    db:
      protocol: custom
  connections:
    instance:
      runnable: gcp-example/postgres-instance
      service: instance
  depends:
    wait-for:
      runnables:
        - gcp-example/postgres-instance
      timeout: 600

app-db-user:
  defines: gcp/cloud-sql-user
  instance: <- connection-target("instance") entity get-member("name")
  name: app_user
  password_secret: app-db-password
  permitted-secrets:
    app-db-password: true
  services:
    user:
      protocol: custom
  connections:
    instance:
      runnable: gcp-example/postgres-instance
      service: instance
  depends:
    wait-for:
      runnables:
        - gcp-example/postgres-instance
      timeout: 600

# =============================================================================
# Step 5: Create BigQuery Dataset
# =============================================================================
# For analytics and data warehousing.

analytics-dataset:
  defines: gcp/big-query
  dataset: app_analytics
  location: US
  description: Analytics data for my application
  labels:
    environment: production
    team: data
  depends:
    wait-for:
      runnables:
        - gcp-example/enable-apis
      timeout: 300

# =============================================================================
# Step 6: Create Cloud Storage Bucket
# =============================================================================
# For file storage and backups.

app-bucket:
  defines: gcp/cloud-storage
  name: my-app-storage-bucket-unique-name  # Must be globally unique!
  location: US
  storage_class: STANDARD
  uniform_bucket_level_access: true
  versioning_enabled: true
  labels:
    environment: production
    purpose: app-storage
  depends:
    wait-for:
      runnables:
        - gcp-example/enable-apis
      timeout: 300

# =============================================================================
# Example: Minimal Cloud SQL Setup
# =============================================================================
# A simpler example with just a database instance.

# minimal-postgres:
#   defines: gcp/cloud-sql-instance
#   name: minimal-db
#   database_version: POSTGRES_14
#   tier: db-f1-micro
#   region: us-central1

# =============================================================================
# Example: Production-Ready Cloud SQL
# =============================================================================
# A more robust configuration for production use.

# production-postgres:
#   defines: gcp/cloud-sql-instance
#   name: prod-postgres
#   database_version: POSTGRES_15
#   tier: db-n1-standard-2
#   region: us-central1
#   allow_all: false
#   deletion_protection: true
#   availability_type: REGIONAL
#   storage_type: PD_SSD
#   storage_size_gb: 100
#   storage_auto_resize: true
#   backup_start_time: "03:00"
#   point_in_time_recovery_enabled: true
