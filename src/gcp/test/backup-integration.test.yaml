# GCP Cloud SQL Backup Integration Test
#
# Tests backup and restore operations for Cloud SQL.
# Run with: sudo INPUT_DIR=./src/gcp/ ./monkec.sh test --test-file test/backup-integration.test.yaml --verbose

name: "GCP Cloud SQL Backup Integration Test"
description: "Integration test for GCP Cloud SQL backup and restore operations"
timeout: 1200000  # 20 minutes - Cloud SQL instance creation and backups take time

setup:
  - name: "Load GCP entity manifest"
    action: "load"
    target: "dist/input/gcp/MANIFEST"
    expect:
      exitCode: 0

  - name: "Load backup test template"
    action: "load"
    target: "test/backup-template.yaml"
    expect:
      exitCode: 0

tests:
  # ==================== SETUP ====================
  - name: "Enable Cloud SQL API"
    action: "run"
    target: "gcp-backup-test/enable-sql-api"
    expect:
      exitCode: 0

  - name: "Wait for API to be enabled"
    action: "wait"
    target: "gcp-backup-test/enable-sql-api"
    waitFor:
      condition: "ready"
      timeout: 120000

  - name: "Create Cloud SQL instance with backup enabled"
    action: "run"
    target: "gcp-backup-test/backup-sql-instance"
    expect:
      exitCode: 0

  - name: "Wait for Cloud SQL instance to be ready"
    action: "wait"
    target: "gcp-backup-test/backup-sql-instance"
    waitFor:
      condition: "ready"
      timeout: 900000  # 15 minutes for instance creation

  - name: "Verify instance is running"
    action: "describe"
    target: "gcp-backup-test/backup-sql-instance"
    expect:
      exitCode: 0

  # ==================== BACKUP INFO ====================
  - name: "Get backup configuration info"
    action: "do"
    target: "gcp-backup-test/backup-sql-instance/get-backup-info"
    expect:
      exitCode: 0
      contains:
        - "Backup"

  # ==================== BACKUP OPERATIONS ====================
  - name: "Create on-demand backup"
    action: "do"
    target: "gcp-backup-test/backup-sql-instance/create-backup"
    args:
      description: "MonkEC integration test backup"
    expect:
      exitCode: 0
      contains:
        - "Backup"

  - name: "List available backups"
    action: "do"
    target: "gcp-backup-test/backup-sql-instance/list-backups"
    expect:
      exitCode: 0

  # Wait for backup to be available
  - name: "Wait for backup availability"
    action: "wait-command"
    target: "monk do gcp-backup-test/backup-sql-instance/list-backups"
    waitFor:
      timeout: 300000
      pollInterval: 30000
    expect:
      exitCode: 0
      contains:
        - "SUCCESSFUL"
    skip_if_missing: true

  # ==================== VALIDATION TESTS ====================
  - name: "Validate describe-backup requires backup_id"
    action: "do"
    target: "gcp-backup-test/backup-sql-instance/describe-backup"
    expect:
      exitCode: 1
      contains:
        - "backup_id"
        - "required"

  - name: "Validate restore requires backup_id"
    action: "do"
    target: "gcp-backup-test/backup-sql-instance/restore"
    expect:
      exitCode: 1
      contains:
        - "backup_id"
        - "required"

  # ==================== INSTANCE HEALTH CHECK ====================
  - name: "Verify instance is healthy after backup operations"
    action: "do"
    target: "gcp-backup-test/backup-sql-instance/get-info"
    expect:
      exitCode: 0

cleanup:
  - name: "Delete Cloud SQL instance"
    action: "delete"
    target: "gcp-backup-test/backup-sql-instance"
    expect:
      exitCode: 0
