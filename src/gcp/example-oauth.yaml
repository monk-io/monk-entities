# GCP OAuth Client Example
#
# This example demonstrates creating OAuth clients and credentials
# for Workforce Identity Federation.
#
# Prerequisites:
# 1. GCP provider configured with appropriate project
# 2. IAM API enabled
# 3. User has roles/iam.oauthClientAdmin role
#
# Usage:
# 1. monk load dist/gcp/MANIFEST
# 2. monk load src/gcp/example-oauth.yaml
# 3. monk update gcp-oauth-example/stack

namespace: gcp-oauth-example

# Enable IAM API (required for OAuth client management)
enable-iam-api:
  defines: gcp/service-usage
  name: iam.googleapis.com

# Create a confidential OAuth client for a web application
web-oauth-client:
  defines: gcp/o-auth-client
  name: monk-example-web-client
  display_name: Monk Example Web Application
  client_description: OAuth client for Monk example web application
  client_type: CONFIDENTIAL_CLIENT
  allowed_grant_types:
    - AUTHORIZATION_CODE_GRANT
    - REFRESH_TOKEN_GRANT
  allowed_redirect_uris:
    - https://myapp.example.com/oauth2/callback
    - http://localhost:3000/oauth2/callback
  allowed_scopes:
    - https://www.googleapis.com/auth/cloud-platform
  depends:
    wait-for:
      runnables:
        - gcp-oauth-example/enable-iam-api
      timeout: 120
  services:
    oauth-client:
      protocol: custom

# Create a credential (client secret) for the OAuth client
web-oauth-credential:
  defines: gcp/o-auth-client-credential
  name: prod-secret-v1
  oauth_client_id: <- connection-target("client") entity-state get-member("client_id")
  secret: gcp-oauth-client-secret
  display_name: Production Secret v1
  permitted-secrets:
    gcp-oauth-client-secret: true
  connections:
    client:
      runnable: gcp-oauth-example/web-oauth-client
      service: oauth-client
  depends:
    wait-for:
      runnables:
        - gcp-oauth-example/web-oauth-client
      timeout: 60

# Create a public OAuth client for a mobile application
mobile-oauth-client:
  defines: gcp/o-auth-client
  name: monk-example-mobile-client
  display_name: Monk Example Mobile App
  client_description: OAuth client for Monk example mobile application
  client_type: PUBLIC_CLIENT
  allowed_grant_types:
    - AUTHORIZATION_CODE_GRANT
  allowed_redirect_uris:
    - myapp://oauth2/callback
    - com.example.myapp:/oauth2redirect
  depends:
    wait-for:
      runnables:
        - gcp-oauth-example/enable-iam-api
      timeout: 120

# Stack to deploy everything
stack:
  defines: process-group
  runnable-list:
    - gcp-oauth-example/enable-iam-api
    - gcp-oauth-example/web-oauth-client
    - gcp-oauth-example/web-oauth-credential
    - gcp-oauth-example/mobile-oauth-client
