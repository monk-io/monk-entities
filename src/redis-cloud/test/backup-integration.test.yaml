name: "Redis Cloud Backup Integration Test"
description: "Integration test for Redis Cloud backup operations using standardized action names"
timeout: 1200000

secrets:
  global:
    redis-cloud-account-key: "$REDIS_CLOUD_ACCOUNT_KEY"
    redis-cloud-user-key: "$REDIS_CLOUD_USER_KEY"
    redis-cloud-backup-db-password: "$REDIS_CLOUD_BACKUP_DB_PASSWORD"
    redis-cloud-backup-pro-password: "$REDIS_CLOUD_BACKUP_PRO_PASSWORD"

setup:
  - name: "Load Redis Cloud entity manifest"
    action: "load"
    target: "dist/input/redis-cloud/MANIFEST"
    expect:
      exitCode: 0

  - name: "Load backup test template"
    action: "load"
    target: "test/backup-template.yaml"
    expect:
      exitCode: 0

tests:
  # ==================== ESSENTIALS DATABASE TESTS ====================
  - name: "Deploy essentials backup stack"
    action: "run"
    target: "redis-cloud-backup-test/essentials-backup-stack"
    expect:
      exitCode: 0

  - name: "Wait for essentials database readiness"
    action: "wait"
    target: "redis-cloud-backup-test/backup-essentials-database"
    waitFor:
      condition: "ready"
      timeout: 600000

  - name: "Verify essentials database is running"
    action: "describe"
    target: "redis-cloud-backup-test/backup-essentials-database"
    expect:
      exitCode: 0

  # Essentials backup operations
  - name: "Get backup info for essentials database"
    action: "do"
    target: "redis-cloud-backup-test/backup-essentials-database/get-backup-info"
    expect:
      exitCode: 0
      contains:
        - "Backup"

  - name: "Create manual backup for essentials database"
    action: "do"
    target: "redis-cloud-backup-test/backup-essentials-database/create-snapshot"
    expect:
      exitCode: 0

  - name: "List backups for essentials database"
    action: "do"
    target: "redis-cloud-backup-test/backup-essentials-database/list-snapshots"
    expect:
      exitCode: 0

  # ==================== PRO DATABASE TESTS ====================
  - name: "Deploy pro backup stack"
    action: "run"
    target: "redis-cloud-backup-test/pro-backup-stack"
    expect:
      exitCode: 0

  - name: "Wait for pro database readiness"
    action: "wait"
    target: "redis-cloud-backup-test/backup-pro-database"
    waitFor:
      condition: "ready"
      timeout: 600000

  - name: "Verify pro database is running"
    action: "describe"
    target: "redis-cloud-backup-test/backup-pro-database"
    expect:
      exitCode: 0

  # Pro backup operations
  - name: "Get backup info for pro database"
    action: "do"
    target: "redis-cloud-backup-test/backup-pro-database/get-backup-info"
    expect:
      exitCode: 0
      contains:
        - "Backup"

  - name: "Create manual backup for pro database"
    action: "do"
    target: "redis-cloud-backup-test/backup-pro-database/create-snapshot"
    expect:
      exitCode: 0

  - name: "List backups for pro database"
    action: "do"
    target: "redis-cloud-backup-test/backup-pro-database/list-snapshots"
    expect:
      exitCode: 0

  # ==================== VALIDATION TESTS ====================
  - name: "Validate restore requires parameters"
    action: "do"
    target: "redis-cloud-backup-test/backup-pro-database/restore"
    expect:
      exitCode: 1
      contains:
        - "source"

cleanup:
  - name: "Delete pro backup stack"
    action: "delete"
    target: "redis-cloud-backup-test/pro-backup-stack"
    expect:
      exitCode: 0

  - name: "Delete essentials backup stack"
    action: "delete"
    target: "redis-cloud-backup-test/essentials-backup-stack"
    expect:
      exitCode: 0

  # Note: Backup files in S3 should be manually cleaned up if needed
