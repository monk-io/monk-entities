namespace: redis-test-stack

# Development Environment Entities

# Essentials Subscription - Free tier for testing
dev-essentials-subscription:
  defines: redis-cloud/subscription
  name: monkec-dev-essentials
  subscription_type: essentials
  provider: AWS
  region: us-east-1
  redis_flex: false
  size: 30
  availability: No replication
  support_data_persistence: false
  support_instant_and_daily_backups: false
  support_replication: false
  support_clustering: false
  support_ssl: false
  account_key_secret: redis-cloud-account-key
  user_key_secret: redis-cloud-user-key
  permitted-secrets:
    redis-cloud-account-key: true
    redis-cloud-user-key: true
  services:
    data:
      protocol: custom
  checks:
    readiness:
      period: 5
      initialDelay: 5
      attempts: 10

# Pro Subscription - Paid tier for advanced features testing
dev-pro-subscription:
  defines: redis-cloud/subscription
  name: monkec-dev-pro
  subscription_type: pro
  provider: AWS
  region: us-east-1
  redis_flex: false
  size: 1
  availability: "Single-zone"
  support_data_persistence: true
  support_instant_and_daily_backups: true
  support_replication: true
  support_clustering: true
  support_ssl: true
  payment_method: credit-card
  account_key_secret: redis-cloud-account-key
  user_key_secret: redis-cloud-user-key
  permitted-secrets:
    redis-cloud-account-key: true
    redis-cloud-user-key: true
  services:
    data:
      protocol: custom
  checks:
    readiness:
      period: 5
      initialDelay: 5
      attempts: 10

# Essentials Database - Free tier testing
dev-essentials-database:
  defines: redis-cloud/essentials-database
  name: monkec-dev-essentials
  subscription_id: <- connection-target("subscription") entity-state get-member("id")
  protocol: redis
  redis_version: "7.2"
  resp_version: resp3
  data_persistence: none
  data_eviction_policy: volatile-lru
  replication: false
  password: "dev-essentials-password-123"
  source_ips:
    - 0.0.0.0/0  # Allow all IPs for testing
  account_key_secret: redis-cloud-account-key
  user_key_secret: redis-cloud-user-key
  permitted-secrets:
    redis-cloud-account-key: true
    redis-cloud-user-key: true
  services:
    data:
      protocol: custom
  connections:
    subscription:
      runnable: redis-test-stack/dev-essentials-subscription
      service: data
  depends:
    wait-for:
      runnables:
        - redis-test-stack/dev-essentials-subscription
      timeout: 300
  checks:
    readiness:
      period: 5
      initialDelay: 5
      attempts: 10

# Pro Database - Advanced features testing
dev-pro-database:
  defines: redis-cloud/pro-database
  name: monkec-dev-pro
  subscription_id: <- connection-target("subscription") entity-state get-member("id")
  protocol: redis
  dataset_size_in_gb: 0.1
  redis_version: "7.2"
  resp_version: resp3
  support_oss_cluster_api: false
  data_persistence: none
  data_eviction_policy: volatile-lru
  replication: false
  password: "dev-pro-password-456"
  source_ip:
    - 0.0.0.0/0  # Allow all IPs for testing
  enable_tls: false
  account_key_secret: redis-cloud-account-key
  user_key_secret: redis-cloud-user-key
  permitted-secrets:
    redis-cloud-account-key: true
    redis-cloud-user-key: true
  services:
    data:
      protocol: custom
  connections:
    subscription:
      runnable: redis-test-stack/dev-pro-subscription
      service: data
  depends:
    wait-for:
      runnables:
        - redis-test-stack/dev-pro-subscription
      timeout: 300
  checks:
    readiness:
      period: 5
      initialDelay: 5
      attempts: 10

# Stack Definitions - Process Groups

dev-essentials-stack:
  defines: process-group
  runnable-list:
    - redis-test-stack/dev-essentials-subscription
    # - redis-test-stack/dev-essentials-database
    # - redis-test-stack/dev-essentials-connection-test

dev-pro-stack:
  defines: process-group
  runnable-list:
    - redis-test-stack/dev-pro-subscription
    - redis-test-stack/dev-pro-database
    - redis-test-stack/dev-pro-connection-test

dev-stack:
  defines: process-group
  runnable-list:
    - redis-test-stack/dev-essentials-subscription
    - redis-test-stack/dev-essentials-database
    - redis-test-stack/dev-essentials-connection-test
    - redis-test-stack/dev-pro-subscription
    - redis-test-stack/dev-pro-database
    - redis-test-stack/dev-pro-connection-test

# Connection Test Containers

dev-essentials-connection-test:
  defines: runnable
  connections:
    db:
      runnable: redis-test-stack/dev-essentials-database
      service: data
  depends:
    wait-for:
      runnables:
        - redis-test-stack/dev-essentials-database
      timeout: 600
  variables:
    redis_host:
      env: REDIS_HOST
      value: <- connection-target("db") entity-state get-member("publicEndpointHost")
      type: string
    redis_port:
      env: REDIS_PORT
      value: <- connection-target("db") entity-state get-member("publicEndpointPort")
      type: string
    redis_password:
      env: REDIS_PASSWORD
      value: <- connection-target("db") entity-state get-member("password")
      type: string
  containers:
    redis-test:
      image: redis:7-alpine
      restart: no
      bash: |
        echo "Testing Redis Cloud Essentials connection..."
        echo "Host: $REDIS_HOST"
        echo "Port: $REDIS_PORT"
        
        # Test connection using redis-cli
        redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" -a "$REDIS_PASSWORD" --no-auth-warning ping
        
        if [ $? -eq 0 ]; then
          echo "✅ Connected to Redis Cloud Essentials successfully!"
          echo "✅ Redis Cloud Essentials test completed successfully!"
        else
          echo "❌ Failed to connect to Redis Cloud Essentials"
          exit 1
        fi

dev-pro-connection-test:
  defines: runnable
  connections:
    db:
      runnable: redis-test-stack/dev-pro-database
      service: data
  depends:
    wait-for:
      runnables:
        - redis-test-stack/dev-pro-database
      timeout: 600
  variables:
    redis_endpoint:
      env: REDIS_ENDPOINT
      value: <- connection-target("db") entity-state get-member("public_endpoint")
      type: string
    redis_password:
      env: REDIS_PASSWORD
      value: <- connection-target("db") entity-state get-member("password")
      type: string
  containers:
    redis-test:
      image: redis:7-alpine
      restart: no
      bash: |
        echo "Testing Redis Cloud Pro connection..."
        echo "Endpoint: $REDIS_ENDPOINT"
        
        # Extract host and port from endpoint
        REDIS_HOST=$(echo "$REDIS_ENDPOINT" | cut -d':' -f1)
        REDIS_PORT=$(echo "$REDIS_ENDPOINT" | cut -d':' -f2)
        
        echo "Host: $REDIS_HOST"
        echo "Port: $REDIS_PORT"
        
        # Test connection using redis-cli
        redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" -a "$REDIS_PASSWORD" --no-auth-warning ping
        
        if [ $? -eq 0 ]; then
          echo "✅ Connected to Redis Cloud Pro successfully!"
          echo "✅ Redis Cloud Pro test completed successfully!"
        else
          echo "❌ Failed to connect to Redis Cloud Pro"
          exit 1
        fi 