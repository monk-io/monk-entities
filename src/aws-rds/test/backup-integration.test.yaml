name: "AWS RDS Backup Integration Test"
description: "Integration test for AWS RDS backup and restore operations including snapshot management"
timeout: 1200000

secrets:
  global:
    test-mysql-backup-password: "$TEST_MYSQL_BACKUP_PASSWORD"

setup:
  - name: "Load AWS RDS entity manifest"
    action: "load"
    target: "dist/input/aws-rds/MANIFEST"
    expect:
      exitCode: 0

  - name: "Load backup test template"
    action: "load"
    target: "backup-template.yaml"
    expect:
      exitCode: 0

tests:
  # ==================== INSTANCE SETUP ====================
  - name: "Deploy backup test instance"
    action: "run"
    target: "aws-rds-backup-test/backup-mysql-instance"
    expect:
      exitCode: 0

  - name: "Wait for instance readiness"
    action: "wait"
    target: "aws-rds-backup-test/backup-mysql-instance"
    waitFor:
      condition: "ready"
      timeout: 900000

  - name: "Verify instance is running"
    action: "describe"
    target: "aws-rds-backup-test/backup-mysql-instance"
    expect:
      exitCode: 0

  # ==================== BACKUP INFO ====================
  - name: "Get backup configuration info"
    action: "do"
    target: "aws-rds-backup-test/backup-mysql-instance/get-backup-info"
    expect:
      exitCode: 0
      contains:
        - "Backup"

  # ==================== SNAPSHOT OPERATIONS ====================
  - name: "Create manual snapshot"
    action: "do"
    target: "aws-rds-backup-test/backup-mysql-instance/create-snapshot"
    args:
      snapshot_id: "monkec-backup-test-snapshot-1"
    expect:
      exitCode: 0
      contains:
        - "Snapshot"

  - name: "List available snapshots"
    action: "do"
    target: "aws-rds-backup-test/backup-mysql-instance/list-snapshots"
    expect:
      exitCode: 0

  # Wait for snapshot to be available
  - name: "Wait for snapshot availability"
    action: "wait-command"
    target: "monk do aws-rds-backup-test/backup-mysql-instance/list-snapshots"
    waitFor:
      timeout: 300000
      pollInterval: 30000
    expect:
      exitCode: 0
      contains:
        - "available"
    skip_if_missing: true

  - name: "Describe specific snapshot"
    action: "do"
    target: "aws-rds-backup-test/backup-mysql-instance/describe-snapshot"
    args:
      snapshot_id: "monkec-backup-test-snapshot-1"
    expect:
      exitCode: 0
    skip_if_missing: true

  # ==================== VALIDATION TESTS ====================
  - name: "Validate describe-snapshot requires snapshot_id"
    action: "do"
    target: "aws-rds-backup-test/backup-mysql-instance/describe-snapshot"
    expect:
      exitCode: 1
      contains:
        - "snapshot_id"

  # ==================== CLEANUP SNAPSHOT ====================
  - name: "Delete test snapshot"
    action: "do"
    target: "aws-rds-backup-test/backup-mysql-instance/delete-snapshot"
    args:
      snapshot_id: "monkec-backup-test-snapshot-1"
    expect:
      exitCode: 0
    skip_if_missing: true

cleanup:
  # Note: If restore was tested, the restored instance should be manually deleted
  - name: "Delete backup test instance"
    action: "delete"
    target: "aws-rds-backup-test/backup-mysql-instance"
    expect:
      exitCode: 0
