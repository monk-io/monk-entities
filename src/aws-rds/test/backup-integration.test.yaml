name: "AWS RDS Backup Integration Test"
description: "Integration test for AWS RDS backup and restore operations including snapshot management"
timeout: 900000

secrets:
  global:
    test-mysql-backup-password: "$TEST_MYSQL_BACKUP_PASSWORD"

setup:
  - name: "Load AWS RDS entity manifest"
    action: "load"
    target: "dist/input/aws-rds/MANIFEST"
    expect:
      exitCode: 0

  - name: "Load backup test template"
    action: "load"
    target: "backup-template.yaml"
    expect:
      exitCode: 0

# tests:
#   - name: "Deploy backup test instance"
#     action: "run"
#     target: "aws-rds-backup-test/backup-mysql-instance"
#     expect:
#       exitCode: 0

#   - name: "Wait for instance readiness"
#     action: "wait"
#     target: "aws-rds-backup-test/backup-mysql-instance"
#     waitFor:
#       condition: "ready"
#       timeout: 600000

#   - name: "Verify instance is running"
#     action: "describe"
#     target: "aws-rds-backup-test/backup-mysql-instance"
#     expect:
#       exitCode: 0

#   # Test get-backup-info action
#   - name: "Get backup configuration info"
#     action: "do"
#     target: "aws-rds-backup-test/backup-mysql-instance/get-backup-info"
#     expect:
#       exitCode: 0

#   # Test create-snapshot action
#   - name: "Create manual snapshot"
#     action: "do"
#     target: "aws-rds-backup-test/backup-mysql-instance/create-snapshot"
#     args:
#       snapshot_id: "monkec-backup-test-snapshot-1"
#     expect:
#       exitCode: 0

#   # Test list-snapshots action (snapshot may still be creating, but action should work)
#   - name: "List available snapshots"
#     action: "do"
#     target: "aws-rds-backup-test/backup-mysql-instance/list-snapshots"
#     expect:
#       exitCode: 0

#   # Test describe-snapshot action
#   - name: "Describe specific snapshot"
#     action: "do"
#     target: "aws-rds-backup-test/backup-mysql-instance/describe-snapshot"
#     args:
#       snapshot_id: "monkec-backup-test-snapshot-1"
#     expect:
#       exitCode: 0

#   # Clean up: Delete the snapshot (may fail if snapshot is still creating - that's OK)
#   - name: "Delete test snapshot"
#     action: "do"
#     target: "aws-rds-backup-test/backup-mysql-instance/delete-snapshot"
#     args:
#       snapshot_id: "monkec-backup-test-snapshot-1"
#     expect:
#       exitCode: 0

cleanup:
  # Note: If restore was tested, the restored instance 'monkec-backup-test-restored' 
  # should be manually deleted via AWS CLI:
  # aws rds delete-db-instance --db-instance-identifier monkec-backup-test-restored --skip-final-snapshot

  - name: "Delete backup test instance"
    action: "delete"
    target: "aws-rds-backup-test/backup-mysql-instance"
    expect:
      exitCode: 0
