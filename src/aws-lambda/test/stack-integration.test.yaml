name: "AWS Lambda Entity Integration Test"
description: "Complete integration test for AWS Lambda entity including blob creation, deployment, and invocation testing"
timeout: 300000

setup:
  - name: "Load AWS Lambda entity manifest"
    action: "load"
    target: "dist/input/aws-lambda/MANIFEST"
    expect:
      exitCode: 0

  - name: "Load test stack template"
    action: "load"
    target: "stack-template.yaml"
    expect:
      exitCode: 0

tests:
  - name: "Deploy Lambda stack"
    action: "run"
    target: "aws-lambda-test/stack"
    expect:
      exitCode: 0

  - name: "Wait for Lambda function readiness"
    action: "wait"
    target: "aws-lambda-test/lambda-function"
    waitFor:
      condition: "ready"
      timeout: 60000

  - name: "Wait for Go Lambda function readiness"
    action: "wait"
    target: "aws-lambda-test/lambda-go-function"
    waitFor:
      condition: "ready"
      timeout: 60000

  - name: "Wait for Container Lambda function readiness"
    action: "wait"
    target: "aws-lambda-test/lambda-container-function"
    waitFor:
      condition: "ready"
      timeout: 60000

  - name: "Verify Lambda function deployment"
    action: "describe"
    target: "aws-lambda-test/lambda-function"
    expect:
      exitCode: 0

  - name: "Verify Go Lambda function deployment"
    action: "describe"
    target: "aws-lambda-test/lambda-go-function"
    expect:
      exitCode: 0

  - name: "Verify Container Lambda function deployment"
    action: "describe"
    target: "aws-lambda-test/lambda-container-function"
    expect:
      exitCode: 0

  - name: "Test Lambda function invocation"
    action: "do"
    target: "aws-lambda-test/lambda-function/invoke"
    args:
      payload: '{"name":"World","source":"integration-test","action":"simple-test"}'
    expect:
      exitCode: 0
      contains:
        - "Hello from AWS Lambda test function!"

  - name: "Test Go Lambda function invocation"
    action: "do"
    target: "aws-lambda-test/lambda-go-function/invoke"
    args:
      payload: '{"name":"World","source":"integration-test","action":"simple-test"}'
    expect:
      exitCode: 0
      contains:
        - "Hello, AWS Lambda!"

  - name: "Test Container Lambda function invocation"
    action: "do"
    target: "aws-lambda-test/lambda-container-function/invoke"
    args:
      payload: '{"name":"World","source":"integration-test","action":"simple-test"}'
    expect:
      exitCode: 0
      contains:
        - "Hello from Lambda!"

  - name: "Test update-code action"
    action: "do"
    target: "aws-lambda-test/lambda-function/update-code"
    expect:
      exitCode: 0
      contains:
        - "Function code updated successfully"

  - name: "Test update-code action for Go Lambda function"
    action: "do"
    target: "aws-lambda-test/lambda-go-function/update-code"
    expect:
      exitCode: 0
      contains:
        - "Function code updated successfully"

  - name: "Test update-code action for Container Lambda function"
    action: "do"
    target: "aws-lambda-test/lambda-container-function/update-code"
    expect:
      exitCode: 0
      contains:
        - "Function code updated successfully"

cleanup:
  - name: "Delete Lambda function"
    action: "delete"
    target: "aws-lambda-test/stack"
    expect:
      exitCode: 0
      