name: "AWS DynamoDB Backup Integration Test"
description: "Integration test for DynamoDB backup and restore operations including PITR and on-demand backups"
timeout: 900000

setup:
  - name: "Load AWS DynamoDB entity manifest"
    action: "load"
    target: "dist/input/aws-dynamo-db/MANIFEST"
    expect:
      exitCode: 0

  - name: "Load backup test template"
    action: "load"
    target: "backup-template.yaml"
    expect:
      exitCode: 0

tests:
  # ==================== TABLE SETUP ====================
  - name: "Deploy backup test table"
    action: "run"
    target: "aws-dynamo-db-backup-test/backup-test-table"
    expect:
      exitCode: 0

  - name: "Wait for table readiness"
    action: "wait"
    target: "aws-dynamo-db-backup-test/backup-test-table"
    waitFor:
      condition: "ready"
      timeout: 120000

  - name: "Verify table is active"
    action: "describe"
    target: "aws-dynamo-db-backup-test/backup-test-table"
    expect:
      exitCode: 0

  # ==================== ADD TEST DATA ====================
  - name: "Insert test item 1"
    action: "do"
    target: "aws-dynamo-db-backup-test/backup-test-table/put-item"
    args:
      item: '{"id":{"S":"backup-test-1"},"name":{"S":"Backup Test Item 1"},"value":{"N":"100"}}'
    expect:
      exitCode: 0

  - name: "Insert test item 2"
    action: "do"
    target: "aws-dynamo-db-backup-test/backup-test-table/put-item"
    args:
      item: '{"id":{"S":"backup-test-2"},"name":{"S":"Backup Test Item 2"},"value":{"N":"200"}}'
    expect:
      exitCode: 0

  - name: "Verify test data inserted"
    action: "do"
    target: "aws-dynamo-db-backup-test/backup-test-table/scan-table"
    expect:
      exitCode: 0

  # ==================== BACKUP INFO ====================
  - name: "Get backup configuration info"
    action: "do"
    target: "aws-dynamo-db-backup-test/backup-test-table/get-backup-info"
    expect:
      exitCode: 0
      contains:
        - "Backup"

  # ==================== SNAPSHOT OPERATIONS ====================
  - name: "Create on-demand backup"
    action: "do"
    target: "aws-dynamo-db-backup-test/backup-test-table/create-snapshot"
    args:
      backup_name: "monkec-test-backup"
    expect:
      exitCode: 0
      contains:
        - "Backup"

  - name: "List available backups"
    action: "do"
    target: "aws-dynamo-db-backup-test/backup-test-table/list-snapshots"
    expect:
      exitCode: 0

  - name: "List backups with limit"
    action: "do"
    target: "aws-dynamo-db-backup-test/backup-test-table/list-snapshots"
    args:
      limit: "5"
    expect:
      exitCode: 0

  # Wait for backup availability
  - name: "Wait for backup availability"
    action: "wait-command"
    target: "monk do aws-dynamo-db-backup-test/backup-test-table/list-snapshots"
    waitFor:
      timeout: 120000
      pollInterval: 15000
    expect:
      exitCode: 0
      contains:
        - "AVAILABLE"
    skip_if_missing: true

  # ==================== VALIDATION TESTS ====================
  - name: "Validate describe-snapshot requires backup_arn"
    action: "do"
    target: "aws-dynamo-db-backup-test/backup-test-table/describe-snapshot"
    expect:
      exitCode: 1
      contains:
        - "backup_arn"

  - name: "Validate restore requires backup_arn or use_latest"
    action: "do"
    target: "aws-dynamo-db-backup-test/backup-test-table/restore"
    args:
      target_table: "test-restored-table"
    expect:
      exitCode: 1
      contains:
        - "backup_arn"

cleanup:
  - name: "Delete backup test table"
    action: "delete"
    target: "aws-dynamo-db-backup-test/backup-test-table"
    expect:
      exitCode: 0

  # Note: Created backups are not automatically deleted
  # They can be cleaned up manually or via delete-snapshot action
