namespace: aws-s3
s3-bucket:
  defines: entity
  metadata:
    name: S3Bucket
    description: |-
      AWS S3 Bucket entity.
      Creates and manages Amazon S3 buckets for scalable object storage.

      ## Secrets
      - Reads: none (authenticated via AWS provider)
      - Writes: none

      ## State Fields for Composition
      - `state.bucket_name` - Bucket name for SDK/API operations
      - `state.region` - AWS region where the bucket resides
      - `state.location` - Bucket location constraint

      ## Composing with Other Entities
      Works with:
      - `aws-iam/role` - Create IAM roles with S3 access permissions
      - `aws-lambda/function` - Store Lambda deployment packages
      - `aws-cloudfront/distribution` - Serve static content via CDN
    version-hash: 2752e45db44d
  schema:
    region:
      type: string
      description: AWS region for the bucket
    bucket_name:
      type: string
      description: S3 bucket name
    versioning:
      type: boolean
      description: Enable or disable bucket versioning
      default: false
    public_read_access:
      type: boolean
      description: Whether to allow public reads (controls public access block)
      default: false
    public_write_access:
      type: boolean
      description: Whether to allow public writes (controls public ACLs)
      default: false
    cors_configuration:
      type: object
      properties:
        cors_rules:
          type: array
          items:
            type: object
            properties:
              allowed_headers:
                type: array
                items:
                  type: string
                description: Allowed headers for CORS requests
              allowed_methods:
                type: array
                items:
                  type: string
                description: Allowed HTTP methods
              allowed_origins:
                type: array
                items:
                  type: string
                description: Allowed origins
              expose_headers:
                type: array
                items:
                  type: string
                description: Response headers to expose
              max_age_seconds:
                type: number
                description: Max age for preflight results
            required:
              - allowed_methods
              - allowed_origins
            additionalProperties: false
          description: List of CORS rules applied to the bucket
      required:
        - cors_rules
      additionalProperties: false
      description: CORS configuration for the bucket
    lifecycle_configuration:
      type: object
      properties:
        rules:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                description: Rule identifier
              status:
                type: string
                enum:
                  - Enabled
                  - Disabled
                description: Rule status
              filter:
                type: object
                properties:
                  prefix:
                    type: string
                    description: Key prefix filter
                  tags:
                    type: object
                    additionalProperties:
                      type: string
                      description: Tag filter
                    description: Tag filter
                additionalProperties: false
                description: Object filter for the rule
              expiration:
                type: object
                properties:
                  days:
                    type: number
                    description: Expire after this many days
                  date:
                    type: string
                    description: Expire on specific date (YYYY-MM-DD)
                additionalProperties: false
                description: Expiration settings
              noncurrent_version_expiration:
                type: object
                properties:
                  noncurrent_days:
                    type: number
                    description: Days until noncurrent versions expire
                required:
                  - noncurrent_days
                additionalProperties: false
                description: Noncurrent version expiration settings
              transitions:
                type: array
                items:
                  type: object
                  properties:
                    days:
                      type: number
                      description: Transition after this many days
                    date:
                      type: string
                      description: Transition on specific date
                    storage_class:
                      type: string
                      enum:
                        - STANDARD_IA
                        - ONEZONE_IA
                        - GLACIER
                        - DEEP_ARCHIVE
                      description: Target storage class
                  required:
                    - storage_class
                  additionalProperties: false
                description: Storage class transition rules
            required:
              - id
              - status
            additionalProperties: false
          description: Lifecycle rules
      required:
        - rules
      additionalProperties: false
      description: Lifecycle rules for automatic transitions/expiration
    server_side_encryption:
      type: object
      properties:
        rules:
          type: array
          items:
            type: object
            properties:
              apply_server_side_encryption_by_default:
                type: object
                properties:
                  sse_algorithm:
                    type: string
                    enum:
                      - AES256
                      - 'aws:kms'
                    description: Algorithm to use
                  kms_master_key_id:
                    type: string
                    description: 'KMS key ID/ARN for aws:kms'
                required:
                  - sse_algorithm
                additionalProperties: false
                description: Default encryption settings
              bucket_key_enabled:
                type: boolean
                description: Enable S3 Bucket Keys for KMS
            required:
              - apply_server_side_encryption_by_default
            additionalProperties: false
          description: Encryption rules
      required:
        - rules
      additionalProperties: false
      description: Default server-side encryption configuration
    website_configuration:
      type: object
      properties:
        index_document:
          type: string
          description: 'Index document for the website (default: index.html)'
        error_document:
          type: string
          description: 'Error document for the website (default: error.html)'
      additionalProperties: false
    bucket_policy:
      type: object
      properties:
        policy:
          anyOf:
            - type: string
            - type: string
              const: public-read
          description: 'JSON policy document as string, or ''public-read'' for standard public read policy'
      required:
        - policy
      additionalProperties: false
    tags:
      type: object
      additionalProperties:
        type: string
        description: Resource tags for the bucket
      description: Resource tags for the bucket
    required:
      - region
      - bucket_name
  state-schema:
    existing:
      type: boolean
      description: Indicates if the bucket pre-existed before this entity managed it
    bucket_name:
      type: string
      description: Bucket name
    region:
      type: string
      description: Bucket region
    location:
      type: string
      description: Bucket location constraint reported by AWS
    required:
      - existing
  lifecycle:
    sync: <<< s3-bucket-sync.js
    get-bucket-info: ''
    list-objects: ''
    generate-presigned-url: ''
    empty-bucket: ''
    get-bucket-statistics: ''
    get-website-info: ''
  checks:
    readiness:
      period: 5
      initialDelay: 2
      attempts: 10
    liveness:
      period: 300
  requires:
    - aws-s3/base
    - monkec/base
    - cli
    - cloud/aws
    - aws-s3/common
