namespace: stripe
webhook-endpoint:
  defines: entity
  metadata:
    name: WebhookEndpoint
    description: |-
      Stripe Webhook Endpoint entity.
      Creates and manages Stripe webhook endpoints for receiving events.
      Webhooks notify your application of events like successful payments.

      ## Secrets
      - Reads: secret name from `secret_ref` property - Stripe API key (defaults to `stripe-api-key`)
      - Writes: secret name from `signing_secret_ref` property - Webhook signing secret (defaults to `stripe-webhook-secret`)
        The signing secret is always created by this entity and stored when the webhook endpoint is created.

      ## State Fields for Composition
      - `state.webhook_endpoint_id` - Webhook endpoint ID
      - `state.webhook_url` - Webhook URL
      - `state.webhook_signing_secret_secret` - Secret name where signing secret is stored

      ## Building destination_url with Connections
      Use `connection-domain-name` or `container-domain-name` to dynamically construct the webhook URL:

      ```yaml
      webhook:
        defines: stripe/webhook-endpoint
        connections:
          backend:
            target: my-namespace/backend
            service: http
        variables:
          backend-public-url:
            type: string
            value: <- "https://" connection-domain-name("backend") concat-all
        destination_url: <- $backend-public-url "/api/stripe/webhook" concat-all
      ```

      For direct runnable references without adding a connection, use `container-domain-name`:
      ```yaml
        destination_url: <- "https://" container-domain-name("my-namespace/app", "app-container") "/webhook" concat-all
      ```

      ## Composing with Other Entities
      Works with:
      - `stripe/credentials` - Validates API access
      - Any runnable/container exposing an HTTP endpoint for webhook delivery
    version-hash: c326f768f517
  schema:
    secret_ref:
      type: string
      minLength: 1
      maxLength: 64
      description: Secret name storing Stripe secret API key (sk_test_... or sk_live_...)
    destination_url:
      type: string
    event_types:
      type: array
      items:
        type: string
    endpoint_description:
      type: string
    signing_secret_ref:
      type: string
      minLength: 1
      maxLength: 64
      description: Secret name to store the signing secret; defaults to stripe-webhook-secret
    required:
      - secret_ref
      - destination_url
  state-schema:
    existing:
      type: boolean
      description: Indicates if the resource already existed before this entity managed it
    webhook_endpoint_id:
      type: string
    webhook_url:
      type: string
    webhook_signing_secret_secret:
      type: string
  lifecycle:
    sync: <<< webhook-endpoint-sync.js
  checks:
    readiness:
      period: 10
      initialDelay: 1
      attempts: 12
  requires:
    - stripe/stripe-base
    - cli
    - secret
