namespace: digitalocean-monitoring
digital-ocean-monitoring:
  defines: entity
  metadata:
    name: DigitalOceanMonitoring
    description: |-
      DigitalOcean Monitoring Alert Policy entity.
      Creates and manages monitoring alert policies for DigitalOcean resources.
      Sends notifications when resource metrics exceed defined thresholds.

      ## Secrets
      - Reads: none (authenticated via DigitalOcean provider)
      - Writes: none

      ## State Fields for Composition
      - `state.uuid` - Alert policy UUID
      - `state.type` - Alert type (CPU, memory, etc.)
      - `state.enabled` - Whether the alert is active

      ## Composing with Other Entities
      Works with:
      - DigitalOcean Droplets, Databases, and other resources as alert targets
    version-hash: 8864af15f946
  schema:
    name:
      type: string
      description: Name of the alert policy
    create_when_missing:
      type: boolean
      description: Whether to create resources when missing - set to false for testing
      default: true
    alert_description:
      type: string
      description: Description of the alert policy
    metric_type:
      type: string
      enum:
        - v1/insights/droplet/cpu
        - v1/insights/droplet/load_1
        - v1/insights/droplet/load_5
        - v1/insights/droplet/load_15
        - v1/insights/droplet/memory_utilization_percent
        - v1/insights/droplet/disk_utilization_percent
        - v1/insights/droplet/disk_read
        - v1/insights/droplet/disk_write
        - v1/insights/droplet/public_outbound_bandwidth
        - v1/insights/droplet/public_inbound_bandwidth
        - v1/insights/droplet/private_outbound_bandwidth
        - v1/insights/droplet/private_inbound_bandwidth
        - v1/insights/lbaas/avg_cpu_utilization_percent
        - v1/insights/lbaas/connection_utilization_percent
        - v1/insights/lbaas/droplet_health
        - v1/insights/lbaas/tls_connections_per_second_utilization_percent
        - v1/insights/lbaas/increase_in_http_error_rate_percentage_5xx
        - v1/insights/lbaas/increase_in_http_error_rate_percentage_4xx
        - v1/insights/lbaas/increase_in_http_error_rate_count_5xx
        - v1/insights/lbaas/increase_in_http_error_rate_count_4xx
        - v1/insights/lbaas/high_http_request_response_time
        - v1/insights/lbaas/high_http_request_response_time_50p
        - v1/insights/lbaas/high_http_request_response_time_95p
        - v1/insights/lbaas/high_http_request_response_time_99p
        - v1/dbaas/alerts/load_15_alerts
        - v1/dbaas/alerts/cpu_alerts
        - v1/dbaas/alerts/memory_utilization_alerts
        - v1/dbaas/alerts/disk_utilization_alerts
        - v1/droplet/autoscale_alerts/current_instances
        - v1/droplet/autoscale_alerts/target_instances
        - v1/droplet/autoscale_alerts/current_cpu_utilization
        - v1/droplet/autoscale_alerts/target_cpu_utilization
        - v1/droplet/autoscale_alerts/current_memory_utilization
        - v1/droplet/autoscale_alerts/target_memory_utilization
        - v1/droplet/autoscale_alerts/scale_up
        - v1/droplet/autoscale_alerts/scale_down
      description: Type of metric to monitor
    compare:
      type: string
      enum:
        - GreaterThan
        - LessThan
      description: Comparison operator for the threshold
    value:
      type: number
      description: Threshold value for the alert
    window:
      type: string
      enum:
        - 5m
        - 10m
        - 30m
        - 1h
      description: Time window for evaluation
    entities:
      type: array
      items:
        type: string
      description: Array of Droplet IDs to monitor
    tags:
      type: array
      items:
        type: string
      description: Array of tags to match Droplets
    emails:
      type: array
      items:
        type: string
      description: Array of email addresses for notifications
    slack_channels:
      type: array
      items:
        type: object
        properties:
          channel:
            type: string
            description: Slack channel name
          url:
            type: string
            description: Slack webhook URL
        required:
          - channel
          - url
        additionalProperties: false
      description: Slack webhook configurations for notifications
    enabled:
      type: boolean
      description: Whether the alert is enabled
      default: true
    required:
      - name
      - metric_type
      - compare
      - value
      - window
  state-schema:
    existing:
      type: boolean
    uuid:
      type: string
    name:
      type: string
    alert_description:
      type: string
    metric_type:
      type: string
      enum:
        - v1/insights/droplet/cpu
        - v1/insights/droplet/load_1
        - v1/insights/droplet/load_5
        - v1/insights/droplet/load_15
        - v1/insights/droplet/memory_utilization_percent
        - v1/insights/droplet/disk_utilization_percent
        - v1/insights/droplet/disk_read
        - v1/insights/droplet/disk_write
        - v1/insights/droplet/public_outbound_bandwidth
        - v1/insights/droplet/public_inbound_bandwidth
        - v1/insights/droplet/private_outbound_bandwidth
        - v1/insights/droplet/private_inbound_bandwidth
        - v1/insights/lbaas/avg_cpu_utilization_percent
        - v1/insights/lbaas/connection_utilization_percent
        - v1/insights/lbaas/droplet_health
        - v1/insights/lbaas/tls_connections_per_second_utilization_percent
        - v1/insights/lbaas/increase_in_http_error_rate_percentage_5xx
        - v1/insights/lbaas/increase_in_http_error_rate_percentage_4xx
        - v1/insights/lbaas/increase_in_http_error_rate_count_5xx
        - v1/insights/lbaas/increase_in_http_error_rate_count_4xx
        - v1/insights/lbaas/high_http_request_response_time
        - v1/insights/lbaas/high_http_request_response_time_50p
        - v1/insights/lbaas/high_http_request_response_time_95p
        - v1/insights/lbaas/high_http_request_response_time_99p
        - v1/dbaas/alerts/load_15_alerts
        - v1/dbaas/alerts/cpu_alerts
        - v1/dbaas/alerts/memory_utilization_alerts
        - v1/dbaas/alerts/disk_utilization_alerts
        - v1/droplet/autoscale_alerts/current_instances
        - v1/droplet/autoscale_alerts/target_instances
        - v1/droplet/autoscale_alerts/current_cpu_utilization
        - v1/droplet/autoscale_alerts/target_cpu_utilization
        - v1/droplet/autoscale_alerts/current_memory_utilization
        - v1/droplet/autoscale_alerts/target_memory_utilization
        - v1/droplet/autoscale_alerts/scale_up
        - v1/droplet/autoscale_alerts/scale_down
    compare:
      type: string
      enum:
        - GreaterThan
        - LessThan
    value:
      type: number
    window:
      type: string
      enum:
        - 5m
        - 10m
        - 30m
        - 1h
    entities:
      type: array
      items:
        type: string
    tags:
      type: array
      items:
        type: string
    emails:
      type: array
      items:
        type: string
    slack_channels:
      type: array
      items:
        type: object
        properties:
          channel:
            type: string
          url:
            type: string
        required:
          - channel
          - url
        additionalProperties: false
    enabled:
      type: boolean
    created_at:
      type: string
  lifecycle:
    sync: <<< digital-ocean-monitoring-sync.js
    list-alert-policies: ''
    get-alert-policy: ''
    get-account-details: ''
    get-droplet-metrics: ''
    get-droplet-cpu-metrics: ''
    get-droplet-memory-metrics: ''
    get-droplet-disk-metrics: ''
    get-droplet-network-metrics: ''
    get-app-metrics: ''
    get-load-balancer-metrics: ''
    get-database-metrics: ''
    enable-alert-policy: ''
    disable-alert-policy: ''
    get-volume-metrics: ''
    get-droplet-bandwidth-inbound: ''
    get-droplet-bandwidth-outbound: ''
    get-droplet-private-bandwidth-inbound: ''
    get-droplet-private-bandwidth-outbound: ''
    get-droplet-disk-read: ''
    get-droplet-disk-write: ''
    get-droplet-load-average1: ''
    get-droplet-load-average5: ''
    get-droplet-load-average15: ''
    delete-alert-policy: ''
    list-sinks: ''
    get-sink: ''
    get-all-droplet-metrics: ''
    get-droplet-memory-available: ''
    get-droplet-memory-cached: ''
    get-droplet-memory-free: ''
    get-droplet-memory-total: ''
    get-droplet-filesystem-free: ''
    get-droplet-filesystem-size: ''
    get-droplet-network-outbound-packets: ''
    get-droplet-network-inbound-packets: ''
    get-droplet-network-outbound-errors: ''
    get-droplet-network-inbound-errors: ''
    get-load-balancer-cpu-utilization: ''
    get-load-balancer-connection-utilization: ''
    get-load-balancer-droplet-health: ''
    get-database-cpu-utilization: ''
    get-database-memory-utilization: ''
    get-database-disk-utilization: ''
    get-volume-filesystem-free: ''
    get-volume-read-bytes: ''
    get-volume-write-bytes: ''
    get-lbcpu-utilization: ''
    get-lbconnection-utilization: ''
    get-lbdroplet-health: ''
    get-lbtls-connections-utilization: ''
    get-lbhttp-error5xx-rate: ''
    get-lbhttp-error4xx-rate: ''
    get-lbhttp-response-time50p: ''
    get-lbhttp-response-time95p: ''
    get-lbhttp-response-time99p: ''
    get-dbload15: ''
    get-dbcpu-alerts: ''
    get-dbmemory-alerts: ''
    get-dbdisk-alerts: ''
    get-app-cpu-percentage: ''
    get-app-memory-percentage: ''
    get-volume-filesystem-size: ''
  checks:
    readiness:
      period: 15
      initialDelay: 5
      attempts: 40
  requires:
    - monkec/base
    - digitalocean-monitoring/do-provider-base
    - digitalocean-monitoring/common
    - cli
