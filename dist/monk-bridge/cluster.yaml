namespace: monk-bridge
cluster:
  defines: entity
  metadata:
    name: Cluster
    description: |-
      Monk Bridge Cluster entity.
      Connects to remote Monk clusters and retrieves cluster information.
      Provides visibility into cluster peers, balancers, and version information.

      ## Secrets
      - Reads: secret name from `monkcode_secret_ref` property - Monk cluster connection code
      - Writes: none

      ## State Fields for Composition
      - `state.cluster_name` - Name of the remote cluster
      - `state.version` - Monk version running on the cluster
      - `state.peers` - List of cluster peers with IPs
      - `state.balancer_endpoints` - Load balancer endpoints

      ## Composing with Other Entities
      Works with:
      - `monk-bridge/runnable` - Retrieve runnable information from this cluster
    version-hash: e229c3dfe3bb
  schema:
    monkcode_secret_ref:
      type: string
    allowed_methods:
      type: array
      items:
        type: string
    expose_balancers:
      type: boolean
    filters:
      type: object
      properties:
        path_filter:
          type: string
        tags_filter:
          type: array
          items:
            type: string
        names_filter:
          type: array
          items:
            type: string
        local:
          type: boolean
      additionalProperties: false
    fetch_templates_info:
      type: boolean
    required:
      - monkcode_secret_ref
  state-schema:
    existing:
      type: boolean
    last_synced_at:
      type: number
    version:
      type: string
    balancers_list:
      type: array
      items:
        type: object
        properties:
          address:
            type: string
          port:
            type: string
          protocol:
            type: string
          publish:
            type: boolean
        required:
          - address
          - port
          - protocol
          - publish
        additionalProperties: false
    cluster_summary_id:
      type: string
    cluster_summary_name:
      type: string
    cluster_summary_open_ports:
      type:
        - string
        - number
    templates_info: {}
    peers:
      type: array
      items:
        type: object
        properties:
          id:
            type: string
          public_ip:
            type: string
          name:
            type: string
          region:
            type: string
          provider:
            type: string
          version:
            type: string
        required:
          - id
        additionalProperties: false
  lifecycle:
    sync: <<< cluster-sync.js
    refresh: ''
  requires:
    - monkec/base
    - cli
    - monk-bridge/monk-bridge-base
