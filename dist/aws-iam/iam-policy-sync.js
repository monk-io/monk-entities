
// Generated by MonkEC - targeting Goja runtime
var __defProp = Object.defineProperty;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __name = (target, value) => __defProp(target, "name", { value, configurable: true });
var __publicField = (obj, key, value) => __defNormalProp(obj, typeof key !== "symbol" ? key + "" : key, value);

// input/aws-iam/policy.ts
const iamBase = require("aws-iam/iam-base");
const AWSIAMEntity = iamBase.AWSIAMEntity;
const common = require("aws-iam/common");
const IAM_ACTIONS = common.IAM_ACTIONS;
const cli = require("cli");
var _IAMPolicy = class _IAMPolicy extends AWSIAMEntity {
  getPolicyName() {
    return this.definition.policy_name;
  }
  customJSONStringify(obj) {
    if (obj === null) return "null";
    if (typeof obj === "undefined") return "undefined";
    if (typeof obj === "string") return '"' + obj.replace(/"/g, '\\"') + '"';
    if (typeof obj === "number" || typeof obj === "boolean") return String(obj);
    if (Array.isArray(obj)) {
      const items = obj.map((item) => this.customJSONStringify(item));
      return "[" + items.join(",") + "]";
    }
    if (typeof obj === "object") {
      const normalized = this.normalizeIndexedObject(obj);
      const keys = Object.keys(normalized);
      const pairs = keys.map((key) => '"' + key + '":' + this.customJSONStringify(normalized[key]));
      return "{" + pairs.join(",") + "}";
    }
    return String(obj);
  }
  normalizeIndexedObject(obj) {
    const result = {};
    const arrayGroups = {};
    for (const key of Object.keys(obj)) {
      if (key.includes("!")) {
        const [baseKey, indexStr] = key.split("!");
        const index = parseInt(indexStr, 10);
        if (!arrayGroups[baseKey]) {
          arrayGroups[baseKey] = [];
        }
        arrayGroups[baseKey][index] = obj[key];
      } else {
        result[key] = obj[key];
      }
    }
    for (const [baseKey, array] of Object.entries(arrayGroups)) {
      result[baseKey] = array.filter((item) => item !== void 0);
    }
    return result;
  }
  create() {
    const existing = this.checkPolicyExists(this.definition.policy_name);
    if (existing?.Policy) {
      this.state = {
        policy_arn: existing.Policy.Arn,
        policy_id: existing.Policy.PolicyId,
        default_version_id: existing.Policy.DefaultVersionId,
        attachment_count: existing.Policy.AttachmentCount,
        create_date: existing.Policy.CreateDate,
        update_date: existing.Policy.UpdateDate,
        existing: true
      };
      return;
    }
    const policyDocument = typeof this.definition.policy_document === "string" ? this.definition.policy_document : this.customJSONStringify(this.definition.policy_document);
    const params = {
      PolicyName: this.definition.policy_name,
      PolicyDocument: policyDocument
    };
    if (this.definition.path) {
      params.Path = this.definition.path;
    }
    if (this.definition.policy_description) {
      params.Description = this.definition.policy_description;
    }
    if (this.definition.tags) {
      let tagIndex = 1;
      for (const [key, value] of Object.entries(this.definition.tags)) {
        params[`Tags.member.${tagIndex}.Key`] = key;
        params[`Tags.member.${tagIndex}.Value`] = value;
        tagIndex++;
      }
    }
    try {
      const response = this.makeAWSRequest("POST", IAM_ACTIONS.CREATE_POLICY, params);
      if (response.Policy) {
        this.state = {
          policy_arn: response.Policy.Arn,
          policy_id: response.Policy.PolicyId,
          default_version_id: response.Policy.DefaultVersionId,
          create_date: response.Policy.CreateDate,
          update_date: response.Policy.UpdateDate
        };
      } else {
        throw new Error("No policy information in CreatePolicy response");
      }
    } catch (error) {
      throw new Error(`Failed to create IAM Policy ${this.definition.policy_name}: ${error instanceof Error ? error.message : "Unknown error"}`);
    }
  }
  update() {
    if (!this.state.policy_arn) {
      this.create();
      return;
    }
    const policyDocument = typeof this.definition.policy_document === "string" ? this.definition.policy_document : this.customJSONStringify(this.definition.policy_document);
    const params = {
      PolicyArn: this.state.policy_arn,
      PolicyDocument: policyDocument,
      SetAsDefault: true
    };
    try {
      const response = this.makeAWSRequest("POST", IAM_ACTIONS.CREATE_POLICY_VERSION, params);
      if (response.PolicyVersion) {
        this.state.default_version_id = response.PolicyVersion.VersionId;
        this.state.update_date = response.PolicyVersion.CreateDate;
      } else {
        throw new Error("Unexpected response format from CreatePolicyVersion");
      }
    } catch (error) {
      throw new Error(`Failed to update IAM Policy ${this.definition.policy_name}: ${error instanceof Error ? error.message : "Unknown error"}`);
    }
  }
  delete() {
    if (!this.state.policy_arn) {
      return;
    }
    if (this.state.existing) {
      return;
    }
    try {
      this.detachPolicyFromAllEntities();
      this.deleteNonDefaultVersions();
      this.deletePolicy(this.state.policy_arn, this.definition.policy_name);
    } catch (error) {
      throw new Error(`Failed to delete IAM Policy ${this.definition.policy_name}: ${error instanceof Error ? error.message : "Unknown error"}`);
    }
  }
  detachPolicyFromAllEntities() {
    if (!this.state.policy_arn) {
      return;
    }
    try {
      const response = this.makeAWSRequest("POST", IAM_ACTIONS.LIST_ENTITIES_FOR_POLICY, {
        PolicyArn: this.state.policy_arn
      });
      if (response.PolicyUsers) {
        const users = Array.isArray(response.PolicyUsers) ? response.PolicyUsers : [response.PolicyUsers];
        for (const user of users) {
          const userName = typeof user === "string" ? user : user.UserName;
          if (userName) {
            try {
              this.makeAWSRequest("POST", IAM_ACTIONS.DETACH_USER_POLICY, {
                UserName: userName,
                PolicyArn: this.state.policy_arn
              });
            } catch (error) {
              cli.output(`Warning: Failed to detach policy from user ${userName}: ${error instanceof Error ? error.message : "Unknown error"}`);
            }
          }
        }
      }
      if (response.PolicyRoles) {
        const roles = Array.isArray(response.PolicyRoles) ? response.PolicyRoles : [response.PolicyRoles];
        for (const role of roles) {
          const roleName = typeof role === "string" ? role : role.RoleName;
          if (roleName) {
            try {
              this.makeAWSRequest("POST", IAM_ACTIONS.DETACH_ROLE_POLICY, {
                RoleName: roleName,
                PolicyArn: this.state.policy_arn
              });
            } catch (error) {
              cli.output(`Warning: Failed to detach policy from role ${roleName}: ${error instanceof Error ? error.message : "Unknown error"}`);
            }
          }
        }
      }
      if (response.PolicyGroups) {
        const groups = Array.isArray(response.PolicyGroups) ? response.PolicyGroups : [response.PolicyGroups];
        for (const group of groups) {
          const groupName = typeof group === "string" ? group : group.GroupName;
          if (groupName) {
            try {
              this.makeAWSRequest("POST", IAM_ACTIONS.DETACH_GROUP_POLICY, {
                GroupName: groupName,
                PolicyArn: this.state.policy_arn
              });
            } catch (error) {
              cli.output(`Warning: Failed to detach policy from group ${groupName}: ${error instanceof Error ? error.message : "Unknown error"}`);
            }
          }
        }
      }
    } catch (error) {
      cli.output(`Warning: Failed to list policy attachments: ${error instanceof Error ? error.message : "Unknown error"}`);
    }
  }
  deleteNonDefaultVersions() {
    try {
      const response = this.makeAWSRequest("POST", IAM_ACTIONS.LIST_POLICY_VERSIONS, {
        PolicyArn: this.state.policy_arn
      });
      if (response.Versions) {
        const nonDefaultVersions = response.Versions.filter((v) => !v.IsDefaultVersion);
        for (const version of nonDefaultVersions) {
          try {
            this.makeAWSRequest("POST", IAM_ACTIONS.DELETE_POLICY_VERSION, {
              PolicyArn: this.state.policy_arn,
              VersionId: version.VersionId
            });
          } catch (error) {
          }
        }
      }
    } catch (error) {
    }
  }
};
__name(_IAMPolicy, "IAMPolicy");
// Customize readiness check parameters - IAM policies can take longer to propagate
__publicField(_IAMPolicy, "readiness", { period: 10, initialDelay: 5, attempts: 18 });
var IAMPolicy = _IAMPolicy;



function main(def, state, ctx) {
  const entity = new IAMPolicy(def, state, ctx);
  return entity.main(ctx);
}
