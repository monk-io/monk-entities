namespace: gcp
cloud-sql-user:
  defines: entity
  metadata:
    name: CloudSqlUser
    description: |-
      Cloud SQL User entity

      Creates a database user within an existing Cloud SQL instance.
      Generates a secure random password and stores it in Monk secrets.

      ## Secrets
      **⚠️ WRITES SECRETS** - This entity writes the database password to a Monk secret.
      You MUST add `permitted-secrets` to allow the entity to write the password:
      ```yaml
      permitted-secrets:
        <password_secret>: true
      ```
      The secret name is specified in the `password_secret` definition field.
      If the secret already contains a password, it will be used; otherwise a new
      16-character random password is generated and stored.

      ## Dependencies
      - **REQUIRED**: `gcp/cloud-sql-instance` - Must be created first
      - Pass the instance name via `instance` field (from instance's `definition.name`)

      ## State Fields for Composition
      The following state fields can be used by other entities:
      - `state.name` - Username for database connections
      - `state.host` - Host restriction (MySQL only, typically "%")

      ## Definition Fields from Other Entities
      - `instance` - Get from `gcp/cloud-sql-instance` entity's `definition.name`

      ## Credentials for Applications
      To connect to the database, your application needs:
      - Host: from `gcp/cloud-sql-instance` `state.address`
      - Port: from `gcp/cloud-sql-instance` `state.port`
      - Database: from `gcp/cloud-sql-database` `state.name`
      - Username: from this entity's `state.name`
      - Password: from Monk secret specified in `password_secret`
    version-hash: 74cf080e0408
  schema:
    project:
      type: string
      description: 'Override the GCP project ID (optional, defaults to environment)'
    instance:
      type: string
      description: Name of the parent Cloud SQL instance
    name:
      type: string
      description: Username for the database user
    password_secret:
      type: string
      description: Secret reference name to store/retrieve the password
    host:
      type: string
      description: 'Host restriction for the user (MySQL only, % for any host)'
    user_type:
      type: string
      description: 'User type (BUILT_IN, CLOUD_IAM_USER, CLOUD_IAM_SERVICE_ACCOUNT)'
      default: BUILT_IN
    required:
      - instance
      - name
      - password_secret
  state-schema:
    existing:
      type: boolean
      description: Indicates if the resource already existed before this entity managed it
    operation_name:
      type: string
      description: Operation name for tracking long-running operations
    name:
      type: string
      description: Username
    host:
      type: string
      description: Host restriction
  lifecycle:
    sync: <<< cloud-sql-user-sync.js
  checks:
    readiness:
      period: 5
      initialDelay: 2
      attempts: 20
    liveness:
      period: 300
  requires:
    - gcp/gcp-base
    - secret
    - cli
    - gcp/common
