namespace: gcp
o-auth-client-credential:
  defines: entity
  metadata:
    name: OAuthClientCredential
    description: |-
      GCP IAM OAuth Client Credential entity

      Creates credentials (client secrets) for OAuth clients and stores them
      in Monk secrets for use by applications.

      ## Secrets
      **⚠️ WRITES SECRETS** - This entity writes the client credentials (JSON with
      clientId and clientSecret) to a Monk secret. You MUST add `permitted-secrets`
      to allow the entity to write the credential:
      ```yaml
      permitted-secrets:
        <secret>: true
      ```

      The secret contains JSON in the format:
      ```json
      {
        "clientId": "...",
        "clientSecret": "..."
      }
      ```

      ## Dependencies
      - **REQUIRED**: `gcp/oauth-client` - Must be created first
      - Pass the OAuth client's `state.client_id` to `oauth_client_id` field

      ## State Fields for Composition
      - `state.credential_id` - Unique identifier for this credential
      - `state.resource_name` - Full resource name for API operations

      ## Required IAM Permissions
      - `iam.oauthClientCredentials.create`
      - `iam.oauthClientCredentials.get`
      - `iam.oauthClientCredentials.delete`

      Or use the predefined role: `roles/iam.oauthClientAdmin`
    version-hash: 8ed7b70e7799
  schema:
    project:
      type: string
      description: 'Override the GCP project ID (optional, defaults to environment)'
    name:
      type: string
      description: The credential ID. Must be unique within the OAuth client.
    secret:
      type: string
      description: |-
        Secret name where the client secret will be stored.
        The secret will contain a JSON object with clientId and clientSecret.
    oauth_client_id:
      type: string
      description: |-
        The OAuth client ID this credential belongs to.
        Usually obtained from connection to `gcp/oauth-client`.
    location:
      type: string
      description: Location for the OAuth client.
      default: global
    display_name:
      type: string
      description: Human-readable display name for this credential.
    disabled:
      type: boolean
      description: Whether the credential is disabled.
      default: false
    required:
      - name
      - secret
      - oauth_client_id
  state-schema:
    existing:
      type: boolean
      description: Indicates if the resource already existed before this entity managed it
    operation_name:
      type: string
      description: Operation name for tracking long-running operations
    resource_name:
      type: string
      description: |-
        Full resource name of the credential.
        Format: projects/{project}/locations/{location}/oauthClients/{clientId}/credentials/{credentialId}
    credential_id:
      type: string
      description: The credential ID
    create_time:
      type: string
      description: When the credential was created
    expire_time:
      type: string
      description: When the credential will expire (if set)
    disabled:
      type: boolean
      description: Whether the credential is disabled
  lifecycle:
    sync: <<< o-auth-client-credential-sync.js
    get-info: ''
    enable: ''
    disable: ''
  checks:
    readiness:
      period: 5
      initialDelay: 2
      attempts: 10
    liveness:
      period: 300
  requires:
    - monkec/base
    - gcp/gcp-base
    - secret
    - cli
    - gcp/common
