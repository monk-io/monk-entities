namespace: gcp
service-account:
  defines: entity
  metadata:
    name: ServiceAccount
    description: |-
      Service Account entity

      Creates and manages GCP service accounts with optional project-level IAM bindings.
      Service accounts are identities used by applications, VMs, and other GCP services.

      ## Secrets
      This entity does NOT write any secrets. To generate credentials for a service account,
      use the `gcp/service-account-key` entity which will write the private key to a Monk secret.

      ## Dependencies
      - Requires `iam.googleapis.com` API to be enabled (use `gcp/service-usage` entity)

      ## State Fields for Composition
      The following state fields can be used by other entities:
      - `state.email` - Service account email for IAM bindings and authentication
      - `state.unique_id` - Numeric ID used by `gcp/service-account-key` to create keys
      - `state.name` - Full resource name (projects/{project}/serviceAccounts/{email})

      ## Composing with Other Entities
      This entity is typically composed with:
      - `gcp/service-account-key` - Pass `state.unique_id` to generate credentials

      The `state.email` can be used for:
      - IAM policy bindings on other resources (buckets, datasets, etc.)
      - Workload Identity bindings for Kubernetes
      - Cloud SQL IAM authentication
    version-hash: d95a4277ce84
  schema:
    project:
      type: string
      description: 'Override the GCP project ID (optional, defaults to environment)'
    name:
      type: string
      description: |-
        Service account ID (will form part of the email address).
        Must be 6-30 characters, start with a letter, and contain only lowercase letters,
        numbers, and hyphens.
        The email will be: {name}@{project}.iam.gserviceaccount.com
    display_name:
      type: string
      description: |-
        Human-readable display name for the service account.
        Shown in the Cloud Console. Max 100 characters.
    account_description:
      type: string
      description: |-
        Description of the service account's purpose.
        Max 256 characters.
    roles:
      type: array
      items:
        type: string
      description: |-
        List of IAM roles to grant to this service account at the project level.
        Use predefined roles (e.g., "roles/storage.admin") or custom roles.
    required:
      - name
  state-schema:
    existing:
      type: boolean
      description: Indicates if the resource already existed before this entity managed it
    operation_name:
      type: string
      description: Operation name for tracking long-running operations
    unique_id:
      type: string
      description: Unique ID of the service account (numeric)
    email:
      type: string
      description: |-
        Email address of the service account.
        Format: {name}@{project}.iam.gserviceaccount.com
    name:
      type: string
      description: |-
        Full resource name of the service account.
        Format: projects/{project}/serviceAccounts/{email}
    display_name:
      type: string
      description: Human-readable display name
    disabled:
      type: boolean
      description: Whether the service account is disabled
    oauth2_client_id:
      type: string
      description: OAuth2 client ID for web applications
  lifecycle:
    sync: <<< service-account-sync.js
    get-info: ''
    enable: ''
    disable: ''
  checks:
    readiness:
      period: 5
      initialDelay: 2
      attempts: 10
    liveness:
      period: 300
  requires:
    - monkec/base
    - gcp/gcp-base
    - cli
    - gcp/common
