namespace: gcp
service-usage:
  defines: entity
  metadata:
    name: ServiceUsage
    description: |-
      Service Usage entity for enabling GCP APIs

      Enables one or more Google Cloud APIs for a project. This is typically
      the first entity in a stack, as other GCP resources require their APIs
      to be enabled before they can be created.

      ## Secrets
      This entity does NOT write any secrets.

      ## Dependencies
      This is a standalone entity with no dependencies on other entities.
      However, other GCP entities typically depend on this entity to ensure
      required APIs are enabled before creating resources.

      ## Composing with Other Entities
      Use this entity as a dependency for other GCP entities that require
      specific APIs to be enabled. No state fields need to be passed to
      dependent entities - they just need to wait for this entity to be ready.
    version-hash: 74cf080e0408
  schema:
    name:
      type: string
      enum:
        - sqladmin.googleapis.com
        - bigquery.googleapis.com
        - storage.googleapis.com
        - iam.googleapis.com
        - cloudresourcemanager.googleapis.com
        - serviceusage.googleapis.com
        - cloudfunctions.googleapis.com
        - run.googleapis.com
        - firebasehosting.googleapis.com
        - firestore.googleapis.com
        - redis.googleapis.com
      description: |-
        Single API name to enable.
        Use this for enabling just one API.
        Format: {service}.googleapis.com (e.g., "sqladmin.googleapis.com").
        Service IDs do not include protocol or path.
    apis:
      type: array
      items:
        type: string
        enum:
          - sqladmin.googleapis.com
          - bigquery.googleapis.com
          - storage.googleapis.com
          - iam.googleapis.com
          - cloudresourcemanager.googleapis.com
          - serviceusage.googleapis.com
          - cloudfunctions.googleapis.com
          - run.googleapis.com
          - firebasehosting.googleapis.com
          - firestore.googleapis.com
          - redis.googleapis.com
      description: |-
        Array of API names to batch enable.
        Use this for enabling multiple APIs efficiently.
        APIs are enabled concurrently in a single operation.
        Service IDs do not include protocol or path.
    project:
      type: string
      description: |-
        Override the GCP project ID.
        If not specified, uses the project from environment/credentials.
  state-schema:
    ready:
      type: boolean
      description: Indicates if all requested APIs are enabled and ready
    operation:
      type: string
      description: Operation name for tracking async enable operation
    enabled_apis:
      type: array
      items:
        type: string
      description: List of APIs that were enabled by this entity
    existing:
      type: boolean
      description: Indicates if APIs were already enabled (adopted)
  lifecycle:
    sync: <<< service-usage-sync.js
  checks:
    readiness:
      period: 10
      initialDelay: 2
      attempts: 30
    liveness:
      period: 300
  requires:
    - monkec/base
    - cloud/gcp
    - cli
    - gcp/common
