namespace: gcp
service-account-key:
  defines: entity
  metadata:
    name: ServiceAccountKey
    description: |-
      Service Account Key entity

      Creates a private key for a GCP service account and stores it in a Monk secret.
      The key can be used by applications to authenticate as the service account.

      ## Secrets
      **⚠️ WRITES SECRETS** - This entity writes the service account private key (JSON credentials)
      to a Monk secret. You MUST add `permitted-secrets` to allow the entity to write the key:
      ```yaml
      permitted-secrets:
        <secret>: true
      ```
      The secret name is specified in the `secret` definition field.

      The secret contains the full JSON credentials file that can be used with
      `GOOGLE_APPLICATION_CREDENTIALS` environment variable or GCP client libraries.

      ## Dependencies
      - **REQUIRED**: `gcp/service-account` - Must be created first
      - Pass the service account's `state.unique_id` to `service_account_id` field

      ## State Fields for Composition
      The following state fields provide key metadata:
      - `state.key_id` - Unique identifier for the key
      - `state.name` - Full resource name of the key
      - `state.valid_after_time` - When the key was created

      ## Definition Fields from Other Entities
      - `service_account_id` - Get from `gcp/service-account` entity's `state.unique_id`

      ## Using the Credentials
      Applications can use the secret in several ways:
      - Set `GOOGLE_APPLICATION_CREDENTIALS` env var to the secret value
      - Pass to GCP client libraries directly
      - Mount as a file in containers
    version-hash: d87fc5c5f384
  schema:
    project:
      type: string
      description: 'Override the GCP project ID (optional, defaults to environment)'
    secret:
      type: string
      description: Secret name where the private key will be stored
    service_account_id:
      type: string
      description: Service account unique ID (usually from connection)
    key_type:
      type: string
      description: Key type
      default: TYPE_GOOGLE_CREDENTIALS_FILE
    key_algorithm:
      type: string
      description: Key algorithm
      default: KEY_ALG_RSA_2048
    required:
      - secret
      - service_account_id
  state-schema:
    existing:
      type: boolean
      description: Indicates if the resource already existed before this entity managed it
    operation_name:
      type: string
      description: Operation name for tracking long-running operations
    name:
      type: string
      description: Full resource name of the key
    key_id:
      type: string
      description: Key ID
    key_algorithm:
      type: string
      description: Key algorithm used
    key_type:
      type: string
      description: Key type
    valid_after_time:
      type: string
      description: When the key was created
  lifecycle:
    sync: <<< service-account-key-sync.js
  checks:
    readiness:
      period: 5
      initialDelay: 2
      attempts: 10
    liveness:
      period: 300
  requires:
    - gcp/gcp-base
    - secret
    - cli
    - gcp/common
