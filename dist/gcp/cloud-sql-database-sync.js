
// Generated by MonkEC - targeting Goja runtime
var __defProp = Object.defineProperty;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __name = (target, value) => __defProp(target, "name", { value, configurable: true });
var __publicField = (obj, key, value) => __defNormalProp(obj, typeof key !== "symbol" ? key + "" : key, value);

// input/gcp/cloudSqlDatabase.ts
const gcpBase = require("gcp/gcp-base");
const GcpEntity = gcpBase.GcpEntity;
const cli = require("cli");
const common = require("gcp/common");
const CLOUD_SQL_API_URL = common.CLOUD_SQL_API_URL;
var _CloudSqlDatabase = class _CloudSqlDatabase extends GcpEntity {
  getEntityName() {
    return `Cloud SQL Database ${this.definition.name} on ${this.definition.instance}`;
  }
  /**
   * Get the API base URL for databases
   */
  get apiUrl() {
    return `${CLOUD_SQL_API_URL}/projects/${this.projectId}/instances/${this.definition.instance}/databases`;
  }
  /**
   * Get database details from API
   */
  getDatabase() {
    return this.checkResourceExists(`${this.apiUrl}/${this.definition.name}`);
  }
  create() {
    const existing = this.getDatabase();
    if (existing) {
      cli.output(`Database ${this.definition.name} already exists on ${this.definition.instance}, adopting...`);
      this.state.existing = true;
      this.state.name = existing.name;
      this.state.self_link = existing.selfLink;
      return;
    }
    const body = {
      name: this.definition.name
    };
    if (this.definition.charset) {
      body.charset = this.definition.charset;
    }
    if (this.definition.collation) {
      body.collation = this.definition.collation;
    }
    cli.output(`Creating database ${this.definition.name} on instance ${this.definition.instance}`);
    const maxRetries = 10;
    const retryDelayMs = 3e4;
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        const result = this.post(this.apiUrl, body);
        this.state.name = this.definition.name;
        this.state.operation_name = result.name;
        this.state.existing = false;
        cli.output(`Database creation started, operation: ${result.name}`);
        return;
      } catch (error) {
        const errorMessage = error instanceof Error ? error.message : String(error);
        if (errorMessage.includes("409")) {
          if (attempt < maxRetries) {
            cli.output(`\u23F3 Another operation is in progress on the instance. Retrying in ${retryDelayMs / 1e3}s... (attempt ${attempt}/${maxRetries})`);
            sleep(retryDelayMs);
            continue;
          }
        }
        throw error;
      }
    }
  }
  update() {
    const existing = this.getDatabase();
    if (!existing) {
      cli.output("Database not found, creating...");
      this.create();
      return;
    }
    cli.output(`Database ${this.definition.name} exists`);
    this.state.name = existing.name;
    this.state.self_link = existing.selfLink;
  }
  delete() {
    if (this.state.existing) {
      cli.output(`Database ${this.definition.name} was not created by this entity, skipping delete`);
      return;
    }
    const existing = this.getDatabase();
    if (!existing) {
      cli.output(`Database ${this.definition.name} does not exist`);
      return;
    }
    cli.output(`Deleting database ${this.definition.name} from instance ${this.definition.instance}`);
    this.httpDelete(`${this.apiUrl}/${this.definition.name}`);
    cli.output(`Database ${this.definition.name} deleted`);
  }
  checkReadiness() {
    if (this.state.operation_name) {
      const operationUrl = `${CLOUD_SQL_API_URL}/projects/${this.projectId}/operations/${this.state.operation_name}`;
      try {
        const operation = this.get(operationUrl);
        if (operation.status === "DONE") {
          if (operation.error) {
            cli.output(`Operation failed: ${JSON.stringify(operation.error)}`);
            return false;
          }
          this.state.operation_name = void 0;
        } else {
          cli.output(`Operation status: ${operation.status}`);
          return false;
        }
      } catch (error) {
        cli.output(`Error checking operation: ${error}`);
        return false;
      }
    }
    const database = this.getDatabase();
    if (!database) {
      cli.output("Database not found");
      return false;
    }
    this.state.name = database.name;
    this.state.self_link = database.selfLink;
    cli.output(`Database ${this.definition.name} is ready`);
    return true;
  }
  checkLiveness() {
    return this.getDatabase() !== null;
  }
};
__name(_CloudSqlDatabase, "CloudSqlDatabase");
__publicField(_CloudSqlDatabase, "readiness", { period: 5, initialDelay: 2, attempts: 20 });
var CloudSqlDatabase = _CloudSqlDatabase;



function main(def, state, ctx) {
  const entity = new CloudSqlDatabase(def, state, ctx);
  return entity.main(ctx);
}
