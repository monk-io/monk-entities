
// Generated by MonkEC - targeting Goja runtime
var __defProp = Object.defineProperty;
var __name = (target, value) => __defProp(target, "name", { value, configurable: true });

// input/azure-cosmosdb/databaseAccount.ts
const azureCosmosdbBase = require("azure-cosmosdb/azure-cosmosdb-base");
const AzureCosmosDBEntity = azureCosmosdbBase.AzureCosmosDBEntity;
const cli = require("cli");
const secret = require("secret");
var _DatabaseAccount = class _DatabaseAccount extends AzureCosmosDBEntity {
  getEntityName() {
    return this.definition.account_name;
  }
  getResourceType() {
    return "databaseAccounts";
  }
  extractArrayFromIndexedFields(obj, fieldName) {
    if (obj && typeof obj === "object" && obj[fieldName] && Array.isArray(obj[fieldName])) {
      return obj[fieldName];
    }
    const result = [];
    let index = 0;
    while (obj && typeof obj === "object" && obj[`${fieldName}!${index}`] !== void 0) {
      let item = obj[`${fieldName}!${index}`];
      item = this.processNestedIndexedFields(item);
      result.push(item);
      index++;
    }
    return result.filter((item) => item != null);
  }
  processNestedIndexedFields(obj) {
    if (!obj || typeof obj !== "object") {
      return obj;
    }
    const processedObj = { ...obj };
    const indexedFields = /* @__PURE__ */ new Set();
    for (const key in processedObj) {
      const match = key.match(/^(.+)!(\d+)$/);
      if (match) {
        const [, fieldName] = match;
        indexedFields.add(fieldName);
      }
    }
    for (const fieldName of indexedFields) {
      const extractedArray = this.extractArrayFromIndexedFields(processedObj, fieldName);
      let index = 0;
      while (processedObj[`${fieldName}!${index}`] !== void 0) {
        delete processedObj[`${fieldName}!${index}`];
        index++;
      }
      if (extractedArray.length > 0) {
        processedObj[fieldName] = extractedArray;
      }
    }
    return processedObj;
  }
  /** Create a new Cosmos DB database account */
  create() {
    const locationsArray = this.extractArrayFromIndexedFields(this.definition, "locations");
    if (!locationsArray || locationsArray.length === 0) {
      throw new Error("At least one location must be specified for the Cosmos DB account");
    }
    const existingAccount = this.checkResourceExists(this.definition.account_name);
    if (existingAccount) {
      const properties2 = existingAccount.properties;
      const provisioningState = typeof properties2?.provisioningState === "string" ? properties2.provisioningState : void 0;
      this.state = {
        account_name: typeof existingAccount.name === "string" ? existingAccount.name : this.definition.account_name,
        provisioning_state: provisioningState,
        document_endpoint: typeof properties2?.documentEndpoint === "string" ? properties2.documentEndpoint : void 0,
        write_locations: Array.isArray(properties2?.writeLocations) ? properties2.writeLocations : void 0,
        read_locations: Array.isArray(properties2?.readLocations) ? properties2.readLocations : void 0,
        existing: true
      };
      cli.output(`\u2705 Database account ${this.definition.account_name} already exists`);
      if (provisioningState === "Succeeded") {
        cli.output(`\u{1F511} Existing account is ready, attempting to populate secrets...`);
        this.populateAccountSecrets();
        this.state.secrets_populated = true;
      }
      return;
    }
    if (this.definition.create_when_missing === false) {
      cli.output(`\u26A0\uFE0F  Database account ${this.definition.account_name} does not exist and create_when_missing is false`);
      this.state = { existing: false };
      return;
    }
    const body = {
      kind: this.definition.account_kind || "GlobalDocumentDB",
      location: this.definition.location || locationsArray[0]?.location_name || "East US",
      properties: {
        databaseAccountOfferType: this.definition.database_account_offer_type || "Standard",
        locations: locationsArray.map((loc) => ({
          locationName: loc.location_name,
          failoverPriority: loc.failover_priority,
          isZoneRedundant: loc.is_zone_redundant || false
        }))
      }
    };
    if (this.definition.consistency_policy) {
      const consistencyPolicy = {
        defaultConsistencyLevel: this.definition.consistency_policy.default_consistency_level
      };
      if (this.definition.consistency_policy.max_staleness_prefix !== void 0) {
        consistencyPolicy.maxStalenessPrefix = this.definition.consistency_policy.max_staleness_prefix;
      }
      if (this.definition.consistency_policy.max_interval_in_seconds !== void 0) {
        consistencyPolicy.maxIntervalInSeconds = this.definition.consistency_policy.max_interval_in_seconds;
      }
      body.properties.consistencyPolicy = consistencyPolicy;
    }
    if (this.definition.enable_automatic_failover !== void 0) {
      body.properties.enableAutomaticFailover = this.definition.enable_automatic_failover;
    }
    if (this.definition.enable_multiple_write_locations !== void 0) {
      body.properties.enableMultipleWriteLocations = this.definition.enable_multiple_write_locations;
    }
    if (this.definition.enable_analytical_storage !== void 0) {
      body.properties.enableAnalyticalStorage = this.definition.enable_analytical_storage;
    }
    if (this.definition.public_network_access !== void 0) {
      body.properties.publicNetworkAccess = this.definition.public_network_access;
    }
    if (this.definition.disable_local_auth !== void 0) {
      body.properties.disableLocalAuth = this.definition.disable_local_auth;
    }
    if (this.definition.tags) {
      body.tags = this.definition.tags;
    }
    const path = this.buildResourcePath(this.definition.account_name);
    const response = this.makeAzureRequest("PUT", path, body);
    if (response.error) {
      throw new Error(`Failed to create database account: ${response.error}, body: ${response.body}`);
    }
    const responseData = this.parseResponseBody(response);
    const properties = responseData?.properties;
    this.state = {
      account_name: this.definition.account_name,
      provisioning_state: typeof properties?.provisioningState === "string" ? properties.provisioningState : void 0,
      document_endpoint: typeof properties?.documentEndpoint === "string" ? properties.documentEndpoint : void 0,
      write_locations: Array.isArray(properties?.writeLocations) ? properties.writeLocations : void 0,
      read_locations: Array.isArray(properties?.readLocations) ? properties.readLocations : void 0,
      existing: false
    };
    cli.output(`\u2705 Created Cosmos DB database account: ${this.definition.account_name}`);
  }
  update() {
    if (!this.state.account_name) {
      this.create();
      return;
    }
    const locationsArray = this.extractArrayFromIndexedFields(this.definition, "locations");
    const body = {
      properties: {}
    };
    let hasChanges = false;
    if (this.definition.consistency_policy) {
      const consistencyPolicy = {
        defaultConsistencyLevel: this.definition.consistency_policy.default_consistency_level
      };
      if (this.definition.consistency_policy.max_staleness_prefix !== void 0) {
        consistencyPolicy.maxStalenessPrefix = this.definition.consistency_policy.max_staleness_prefix;
      }
      if (this.definition.consistency_policy.max_interval_in_seconds !== void 0) {
        consistencyPolicy.maxIntervalInSeconds = this.definition.consistency_policy.max_interval_in_seconds;
      }
      body.properties.consistencyPolicy = consistencyPolicy;
      hasChanges = true;
    }
    if (locationsArray && locationsArray.length > 0) {
      body.properties.locations = locationsArray.map((loc) => ({
        locationName: loc.location_name,
        failoverPriority: loc.failover_priority,
        isZoneRedundant: loc.is_zone_redundant || false
      }));
      hasChanges = true;
    }
    if (this.definition.enable_automatic_failover !== void 0) {
      body.properties.enableAutomaticFailover = this.definition.enable_automatic_failover;
      hasChanges = true;
    }
    if (this.definition.enable_multiple_write_locations !== void 0) {
      body.properties.enableMultipleWriteLocations = this.definition.enable_multiple_write_locations;
      hasChanges = true;
    }
    if (this.definition.public_network_access !== void 0) {
      body.properties.publicNetworkAccess = this.definition.public_network_access;
      hasChanges = true;
    }
    if (this.definition.disable_local_auth !== void 0) {
      body.properties.disableLocalAuth = this.definition.disable_local_auth;
      hasChanges = true;
    }
    if (this.definition.tags) {
      body.tags = this.definition.tags;
      hasChanges = true;
    }
    if (!hasChanges) {
      cli.output(`\u2139\uFE0F  No changes detected for database account: ${this.definition.account_name}`);
      return;
    }
    const path = this.buildResourcePath(this.definition.account_name);
    const response = this.makeAzureRequest("PATCH", path, body);
    if (response.error) {
      throw new Error(`Failed to update database account: ${response.error}, body: ${response.body}`);
    }
    const responseData = this.parseResponseBody(response);
    if (responseData) {
      const properties = responseData.properties;
      this.state.provisioning_state = typeof properties?.provisioningState === "string" ? properties.provisioningState : void 0;
      this.state.document_endpoint = typeof properties?.documentEndpoint === "string" ? properties.documentEndpoint : void 0;
      this.state.write_locations = Array.isArray(properties?.writeLocations) ? properties.writeLocations : void 0;
      this.state.read_locations = Array.isArray(properties?.readLocations) ? properties.readLocations : void 0;
    }
    cli.output(`\u2705 Updated Cosmos DB database account: ${this.definition.account_name}`);
  }
  delete() {
    if (!this.state.account_name) {
      cli.output("Database account does not exist, nothing to delete");
      return;
    }
    this.deleteResource(this.definition.account_name);
  }
  checkReadiness() {
    if (!this.state.account_name) {
      return false;
    }
    if (this.definition.create_when_missing === false && !this.state.existing) {
      return true;
    }
    try {
      const account = this.checkResourceExists(this.definition.account_name);
      if (!account) {
        cli.output(`\u23F3 Database account ${this.definition.account_name} not found`);
        return false;
      }
      const properties = account.properties;
      const provisioningState = typeof properties?.provisioningState === "string" ? properties.provisioningState : void 0;
      const isReady = provisioningState === "Succeeded";
      if (isReady) {
        cli.output(`\u2705 Database account ${this.definition.account_name} is ready (status: ${provisioningState})`);
        this.state.provisioning_state = provisioningState;
        this.state.document_endpoint = typeof properties?.documentEndpoint === "string" ? properties.documentEndpoint : void 0;
        this.state.write_locations = Array.isArray(properties?.writeLocations) ? properties.writeLocations : void 0;
        this.state.read_locations = Array.isArray(properties?.readLocations) ? properties.readLocations : void 0;
        if (!this.state.secrets_populated) {
          cli.output(`\u{1F511} Account is ready, attempting to populate secrets...`);
          this.populateAccountSecrets();
          this.state.secrets_populated = true;
        }
      } else {
        cli.output(`\u23F3 Database account ${this.definition.account_name} not ready yet (status: ${provisioningState || "unknown"})`);
      }
      return isReady;
    } catch (error) {
      cli.output(`\u26A0\uFE0F  Failed to check database account readiness: ${error instanceof Error ? error.message : "Unknown error"}`);
      return false;
    }
  }
  checkLiveness() {
    return this.checkReadiness();
  }
  /**
   * Populate secrets with account credentials if secret references are provided
   */
  populateAccountSecrets() {
    if (!this.definition.primary_key_secret_ref && !this.definition.secondary_key_secret_ref) {
      return;
    }
    if (this.definition.primary_key_secret_ref || this.definition.secondary_key_secret_ref) {
      try {
        const keysPath = `/subscriptions/${this.definition.subscription_id}/resourceGroups/${this.definition.resource_group_name}/providers/Microsoft.DocumentDB/databaseAccounts/${this.definition.account_name}/listKeys?api-version=${this.apiVersion}`;
        const keysResponse = this.makeAzureRequest("POST", keysPath);
        if (keysResponse.error) {
          cli.output(`\u26A0\uFE0F  Failed to retrieve access keys: ${keysResponse.error}`);
          return;
        }
        const keysData = this.parseResponseBody(keysResponse);
        if (keysData) {
          if (this.definition.primary_key_secret_ref && typeof keysData.primaryMasterKey === "string") {
            try {
              secret.set(this.definition.primary_key_secret_ref, keysData.primaryMasterKey);
              cli.output(`\u{1F511} Saved primary key to secret: ${this.definition.primary_key_secret_ref}`);
            } catch (error) {
              cli.output(`\u26A0\uFE0F  Failed to save primary key to secret: ${this.definition.primary_key_secret_ref}`);
            }
          }
          if (this.definition.secondary_key_secret_ref && typeof keysData.secondaryMasterKey === "string") {
            try {
              secret.set(this.definition.secondary_key_secret_ref, keysData.secondaryMasterKey);
              cli.output(`\u{1F511} Saved secondary key to secret: ${this.definition.secondary_key_secret_ref}`);
            } catch (error) {
              cli.output(`\u26A0\uFE0F  Failed to save secondary key to secret: ${this.definition.secondary_key_secret_ref}`);
            }
          }
        } else {
          cli.output(`\u26A0\uFE0F  No keys data received from Azure API`);
        }
      } catch (error) {
        cli.output(`\u26A0\uFE0F  Failed to fetch access keys from Azure: ${error instanceof Error ? error.message : "Unknown error"}`);
      }
    }
  }
};
__name(_DatabaseAccount, "DatabaseAccount");
var DatabaseAccount = _DatabaseAccount;



function main(def, state, ctx) {
  const entity = new DatabaseAccount(def, state, ctx);
  return entity.main(ctx);
}
